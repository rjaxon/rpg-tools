<!DOCTYPE html>
<html lang="en">
    <head>
        <title>
            RJ's RPG Tools - Oracle
        </title>

        <link rel="icon" href="img/icons/ffffff/000000/1x1/delapouite/dice-twenty-faces-twenty.svg">

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

        <link href="css/dice.css" rel="stylesheet">

        <script src="scripts/util.js"></script>
        <script src="scripts/dice.js"></script>
        <script src="scripts/data.js"></script>
        <script src="scripts/data/icons.js"></script>

        <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.6.2.min.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">

    </head>
<style>

    ul {
      margin-bottom: 0px;
    }

    textarea {
        resize: none;
        width: 100%;
        height: 100%;
        border: 0px;
    }

    textarea:hover {
        border: none; /* Removes the border */
        outline: none; /* Removes the outline */
    }

    .hidden {
        display: none;
    }

    .label {
      font-weight: bold;
    }

    .pointer {
      cursor: pointer;
    }

    .red {
      color: red;
    }

    .bold {
      font-weight: bold;
    }

    .crossout {
      text-decoration: line-through;
    }

    .max-width {
      width: 100%;
    }

    .thread-tab {
      margin-right: 5px;
    }

    .button-item {
      border-radius: 5px;
      border-bottom-left-radius: unset;
      border-bottom-right-radius: unset;
      border-bottom-color: white;
    }

    .oracle-scene-stage {
    }

    button.selected {
      background: white;
      border: 2px solid black;
      border-bottom-color: white;
      position: relative;
      top: 2px;
    }

    #oracle-container {
      padding: 1em;;
    }
    
    #oracle {
    }

    #oracle-result {
      border-radius: 5px;
      border-top-left-radius: unset;
      padding: 2em;
      font-weight: bold;
      font-size: 2em;
      text-align: center;
      border-left: 2px solid black;
      border-right: 2px solid black;
      border-top: 2px solid black;
      border-bottom-left-radius: unset;
      border-bottom-right-radius: unset;
    }

    #oracle-result-contents-hint {
      border-left: 2px solid black;
      border-right: 2px solid black;
      border-bottom: 2px solid black;
      border-radius: 5px;
      border-top-left-radius: unset;
      border-top-right-radius: unset;
      padding-left: 1em;
      padding-right: 1em;
      padding-bottom: 1em;
      text-align: center;
    }

    #oracle-result-contents {
      cursor: pointer;
    }

    .oracle-result-image {
      padding: 5px;
    }

    .oracle-scene-stage-item {
      border: 1px solid black;
    }

/*********************************/


  #thread-container {
    padding: 1em;
  }

  #thread-details {
    border-top: 2px solid black;
    border-left: 2px solid black;
    border-right: 2px solid black;
    border-radius: 5px;
    border-top-left-radius: unset;
    border-bottom-left-radius: unset;
    border-bottom-right-radius: unset;
  }

  #thread-details-contents {
    padding: 10px;
  }

  #thread-details-contents-input {
    height: 300px;
  }

  #threads-footer {
    height: 2.5em;
    text-align: right;
    padding-right: 10px;
    border-bottom: 2px solid black;
    border-left: 2px solid black;
    border-right: 2px solid black;

    border-radius: 5px;
    border-top-left-radius: unset;
    border-top-right-radius: unset;
  }


</style>

<body>

  <div id="oracle-container">
    <div id="oracle">
       <div id="oracle-surge" class="hidden">0</div>
        <div class="row">
            <div class="col-12">
              <div class="w3-bar w3-black">
                <button type="oracle" class="w3-bar-item w3-button button-item oracle-scene-stage selected" value="1" onclick="tab_click(this);">To Knowledge</button>
                <button type="oracle" class="w3-bar-item w3-button button-item oracle-scene-stage" value="2" onclick="tab_click(this);">To Conflict</button>
                <button type="oracle" class="w3-bar-item w3-button button-item oracle-scene-stage" value="3" onclick="tab_click(this);">To Endings</button>
              </div>
            </div>
            <div class="col-sm">
                <div id="oracle-result" value="1" surge="0">
                  <div id="oracle-result-contents" onclick="oracle_result_contents_click(this);">
                    Click here to query the loom of fate 
                  </div>
                </div>
            </div>
            <div class="col-12">
                  <div id="oracle-result-contents-hint"> </div>
            </div>
        </div>
    </div>
  </div>

  <div id="thread-container">
    <div id="threads">
      <div class="row">
        <div class="col-12">
            <!--button id="a-guid-001" type="threads" class="w3-bar-item w3-button button-item oracle-scene-stage selected" onclick="tab_click(this);">Thread 1</button>
            <button id="a-guid-001" type="threads" class="w3-bar-item w3-button button-item oracle-scene-stage" onclick="tab_click(this);">Thread 2</button>
            <button id="a-guid-001" type="threads" class="w3-bar-item w3-button button-item oracle-scene-stage" onclick="tab_click(this);">Thread 3</button>
            <button id="a-guid-001" type="threads" class="w3-bar-item w3-button button-item oracle-scene-stage" onclick="tab_click(this);">Thread 4</button-->
            <button  class="w3-bar-item w3-button button-item oracle-scene-stage" onclick="new_thread_click(this);">Add Thread</button>
        </div>

        <div class="col-sm">
            <div id="thread-details">
              <div id="thread-details-contents">
                <div class="row">
                  <div class="col-12 label"><span id="thread-title" field="title" class="pointer editable" onclick="thread_item_click(this);")>Thread 1 Long Title</span></div>
                  <div class="col-12 label">Description</div>
                  <div class="col-12">
                    <span id="thread-description" field="description" class="pointer editable"  onclick="thread_item_click(this);")>
                    We were hired to find the victim and the kidnapper.
                    </span>
                  </div>
                  <div class="col-12 label">Facts</div>
                  <div class="col-12">
                      <ul id="thread-facts" field="facts">
                        <li class="thread-list-item"><span class="pointer" onclick="thread_list_item_click(this);">The mother was not around during the incident</span></li>
                        <li class="thread-list-item"><span class="pointer" onclick="thread_list_item_click(this);">The victim was trying to meet someone</span></li>
                        <li class="thread-list-item"><span class="pointer" onclick="thread_list_item_click(this);">The victom is male</span></li>
                        <li><span command="add-fact" class="pointer" onclick="thread_list_item_add(this);">Add Fact</span></li>
                      </ul>
                  </div>
                  <div class="col-12 label">Questions / Rumors</div>
                  <div class="col-12">
                      <ul id="thread-questions" field="questions">
                        <li class="thread-list-item" index="0"><span class="pointer" onclick="thread_list_item_click(this);">Where was the mother?</span></li>
                        <li class="thread-list-item" index="1"><span class="pointer" onclick="thread_list_item_click(this);">What is the victim's name?</span></li>
                        <li class="thread-list-item" index="2"><span class="pointer" onclick="thread_list_item_click(this);">Who was the victim trying to meet?</span></li>
                        <li><span command="add-question" class="pointer" onclick="thread_list_item_add(this);">Add Question</span></li>
                      </ul>
                  </div>

                  <div class="col-12 label">Notable Characters</div>
                  <div class="col-sm character-list-item">Character Name 1</div>
                  <div class="col-sm character-list-item">Character Name 2</div>
                  <div class="col-sm character-list-item">Character Name 3</div>
                  <div class="col-sm character-list-item">Character Name 4</div>
                  <div class="col-sm">Add Existing NPC</div>

                  <div class="col-12 label">Scenes</div>
                  <div class="col-sm scene-list-item">Scene 1</div>
                  <div class="col-sm scene-list-item">Scene 2</div>
                  <div class="col-sm scene-list-item">Scene 3</div>
                  <div class="col-sm scene-list-item">Scene 4</div>
                  <div class="col-sm scene-list-item">Scene 5</div>
                  <div class="col-sm">Add Scene</div>
                </div>
              </div>
              <div id="thread-details-contents-input" class="hidden">
                  <textarea id="thread-details-contents-input-textarea"></textarea>
              </div>
            </div>
        </div>

        <div class="col-12">
            <div id="threads-footer">
              <button>Edit</button>
              <button>Ok</button>
            </div>
        </div>

      </div>
    </div>
  </div>



</body>


    <script type="text/javascript">


function thread_new(data) {

  let thread = {
    id: data?.id || crypto.randomUUID(),
    title: data?.title,
    description: data?.description,
    facts: data?.facts,
    questions: data?.questions,
    characters: data?.characters,
    scenes: data?.scenes
  };

  // thread.facts = [
  //   {status: 0, text: 'fact one'},
  //   {status: 1, text: 'fact two'},
  //   null, // {status: 1, text: 'fact thress'},
  //   {status: 0, text: 'fact 3 one'},
  //   {status: 1, text: 'fact 2 two'},
  //   {status: 1, text: 'fact 1 thress'}
  // ];

  // thread.questions = [
  //   {status: 0, text: 'one'},
  //   {status: 1, text: 'two'},
  //   {status: 1, text: 'thress'}
  // ];


  return thread;
}

let data_oracle_loom = [
  {id: 'oracle_cgre_loom', note: 'column 0 is a list of distributions for knowledge, conflict, ending'},
         /*  | knowledge |  conflict |  endings   | */
    [ [[0, 0], [  1,   5], [  1,   2], [  1,   1]  ], 'No, and unexpectedly'],
    [ [[0, 0], [  6,  15], [  3,   6], [  2,   2]  ], 'No, but'],
    [ [[0, 0], [ 16,  20], [  7,  16], [  3,  20]  ], 'No, and'],
    [ [[0, 0], [ 21,  50], [ 17,  50], [ 21,  50]  ], 'No'],
    [ [[0, 0], [ 51,  80], [ 51,  84], [ 51,  80]  ], 'Yes'],
    [ [[0, 0], [ 81,  85], [ 85,  94], [ 81,  98]  ], 'Yes, and'],
    [ [[0, 0], [ 86,  95], [ 95,  98], [ 99,  99]  ], 'Yes, but'],
    [ [[0, 0], [ 96, 100], [ 99, 100], [100, 100]  ], 'Yes, and unexpectedly'],
];


let data_oracle_crge_unexpected = [
  { id: 'oracle_cgre_unexpected' },
  [ 'Foreshadowing', 'Set a thread to be the main thread for the next scene. The current scene should then start wrapping up and heading towards the next scene.'],
  [ 'Tying Off ', 'The main thread resolves or substantially moves forward in this scene by narrative decree. This does not mean that the main thread cannot create follow-up threads.'],
  [ 'To Conflict', 'The next scene centers on a conflict of your choosing. Set the main elements of the next scene, and start heading toward them in this scene.'],
  [ 'Costume Change', 'An NPC drastically changes their mind, motivations, alliances, etc. for better or worse. This could be a big story reveal or a simple change of heart.'],
  [ 'Key Grip', 'Set the location or general elements for the next scene. The current scene should then start wrapping up and heading towards the next scene.'],
  [ 'To Knowledge', 'The next scene centers on lore or investigation of your choosing. Set the main elements of the next scene, and start heading toward them in this scene.'],
  [ 'Framing', 'An NPC (new or pre-existing) or object becomes critical to the main thread.'],
  [ 'Set Change', 'Scene continues in another location. The current thread remains as much as makes sense.'],
  [ 'Upstaged', 'An NPC makes a big move. If the NPC has any motivations, plot vectors, or goals they go into overdrive'],
  [ 'Pattern Change', 'The main thread gets modified, drastically. Whatever direction the main thread was heading, make a hard left. Use a generator, such as Rory’s Story Cubes, tarot cards or a random Wikipedia page, as necessary.'],
  [ 'Limelit', 'The rest of the scene goes great for the PC’s. Assume that the majority of the questions pertaining to the main thread with regard to the scene are answered in a way that benefits the PC’s.'],
  [ 'Entering the Red', 'Threat of danger or combat arrives. The premise of the scene gets more dangerous in a way that forces the PC’s to respond by leaving, fighting, or taking their chances.'],
  [ 'To Endings', 'The next scene resolves or substantially moves forward a thread of your choosing. Set the main elements of the next scene, and start heading toward them in this scene.'],
  [ 'Montage', 'The timeframe of the scene changes to a montage of actions set across various scenes to move forward.'],
  [ 'Enter Stage Left', 'A PC or NPC (new or pre-existing) arrives fresh in the scene.'],
  [ 'Cross-stitch', 'Choose another thread to be the main thread for the rest of the scene.'],
  [ 'Six Degrees', 'A meaningful, but not always positive, connection forms between two PC’s and/or NPC’s.'],
  [ 'Reroll / Reserved 1', 'These slots are reserved for specific “GM actions” found in an RPG system, such as a compel action in the FATE system. Specific examples can be found at conjecturegames.com.'],
  [ 'Reroll / Reserved 2', 'These slots are reserved for specific “GM actions” found in an RPG system, such as a compel action in the FATE system. Specific examples can be found at conjecturegames.com.'],
  [ 'Reroll / Reserved 3', 'These slots are reserved for specific “GM actions” found in an RPG system, such as a compel action in the FATE system. Specific examples can be found at conjecturegames.com.']

];


// https://alyssalostinspace.com/wp-content/uploads/2022/09/d100-keyword-chart.pdf
let data_plot_hooks = [
  {id: 'plot_hooks'},
  /* who, where, what, description, additional element, sensory detail */
['Priest', 'Village', 'Pyre', 'Decayed', 'Fall', 'Rustling Leaves'],
['Ghost', 'Plains', 'Tome', 'Abandoned', 'Puzzle', 'Eerie Silence'],
['Minstrel', 'Lake', 'Lock', 'Scorched', 'Escape', 'Birdsong'],
['Heretic', 'Cliffs', 'Cage', 'Sparkling', 'Fear', 'Distant Shouts'],
['Veteran', 'Fortress', 'Heirloom', 'Embroidered', 'Betray', 'Ominous Echo'],
['Trickster', 'Wasteland', 'Drug', 'Torn', 'Drown', 'Thick Smoke'],
['Researcher', 'Farm', 'Book', 'Damaged', 'Despair', 'Wet Earth'],
['Cultist', 'Swamp', 'Sword', 'Ancient', 'Loss', 'Damp Wood'],
['Ruler', 'Glade', 'Totem', 'Carved', 'Marriage', 'A Swinging Blade'],
['Prophet', 'Sewers', 'Dagger', 'Ornate', 'Extortion', 'Crackling Fire'],
['Pirate', 'Forest', 'Egg', 'Possessed', 'Blessing', 'Bubbling Cauldron'],
['Cartographer', 'Trail', 'Door', 'Small', 'Feud', 'Soft Weeping'],
['Scholar', 'Monastery', 'Secret', 'Stolen', 'Protect', 'Shattering Glass'],
['Monk', 'Garden', 'Letter', 'corrupted', 'Heresy', 'Tingling Skin'],
['Slave', 'Mountains', 'Curse', 'Enchanted', 'Climb', 'Quiet Singing'],
['Child', 'Observatory', 'Puzzle', 'Forged', 'Espionage', 'Beating ofLarge Wings'],
['Spy', 'Museum', 'Shield', 'Collapsed', 'Belief', 'Sulfuric Odor'],
['God', 'Temple', 'Song', 'Rusted', 'Mystery', 'Burning Wood'],
['Courtesan', 'Sea', 'Campfire', 'Cracked', 'Revenge', 'Metallic Odor'],
['Merchant', 'Bridge', 'Tool', 'Vibrant', 'Prejudice', 'Light Rain'],
['Healer', 'Prison', 'Storm', 'Worn', 'Discover', 'Animal Calls'],
['Knight', 'Marsh', 'Ship', 'Pearlescent', 'Assassination', 'Clashing of Steel'],
['Blacsmith', 'Desert', 'Shrine', 'Ruined', 'Promise', 'Pouring Tea'],
['Thief', 'Lair', 'Poison', 'Valuable', 'Journey', 'Cooking Spices'],
['Fortune Teller', 'Caravan', 'Artifact', 'Polished', 'Jealousy', 'Heavy Perfume'],
['Noble', 'Ruins', 'Seal', 'Divine', 'Obsession', 'Fresh Blood'],
['Spirit', 'Greatwood', 'Map', 'Forgotten', 'Endure', 'Buzzing in the Air'],
['Sailor', 'Battlefield', 'Promise', 'Floating', 'Memory', 'A Slick Surface'],
['Mage', 'Waterfall', 'Decoy', 'Cursed', 'Return', 'A Distant Glow'],
['Soldier', 'Coast', 'Painting', 'Pulsating', 'Exchange', 'Falling Snow'],
['Undertaker', 'Valley', 'Signal', 'Blighted', 'Redemption', 'Something Hissing Nearby'],
['Witch', 'Palace', 'Chest', 'Frozen', 'Disease', 'Snapping Branches'],
['Alchemist', 'Harbor', 'Treasure', 'Weathered', 'Love', 'Heavy, Humid Air'],
['Smuggler', 'Catacombs', 'Rune', 'Sticky', 'Destroy', 'Burning in the Back ofYour Throat'],
['Necromancer', 'Tower', 'Portal', 'Gilded', 'Break', 'Jangling Coins'],
['Servant', 'Ravine', 'Name', 'Hungry', 'Guilt', 'Footsteps in Mud'],
['Monk', 'Cairn', 'Obelisk', 'Massive', 'Forgive', 'The Smell of Old Parchment'],
['Assassin', 'City', 'Statue', 'Colourful', 'Travel', 'Roasting Meat'],
['Emissary', 'Graveyard', 'Tree', 'Broken', 'Arrive', 'Heavy Rain'],
['Professor', 'Abbey', 'Bell', 'Silvery', 'Reconciliation', 'An Herbal Aroma'],
['Dragon', 'Hideout', 'Arrow', 'Illegal', 'Control', 'Grinding Teeth'],
['Artist', 'Altar', 'Amulet', 'Whispering', 'Risk', 'Spoiled Meat'],
['Gladiator', 'River', 'Coin', 'Ashen', 'Abandon', 'Bracing Breeze'],
['Engineer', 'Library', 'Key', 'Fragile', 'Repulse', 'Pressure on Your Mind'],
['Farmer', 'Oasis', 'Instrument', 'Glassy', 'Mourn', 'A Cry for Help'],
['Mercenary', 'Grove', 'Tomb', 'Glowing', 'Create', 'A Rumble ofThunder'],
['Bandit', 'Tavern', 'Monument', 'Sentient', 'Expense', 'Fresh Baked Bread'],
['Criminal', 'Castle', 'Flower', 'Singing', 'Flee', 'Heaving Coughs'],
['Orphan', 'Hamlet', 'Pearl', 'Sodden', 'Hypocrisy', 'A Blaring Horn'],
['Guildmaster', 'Dungeon', 'Wine', 'Fettered', 'Humiliatioon', 'Gentle Music'],
['Ship Captain', 'Guild', 'Flag', 'Sealed', 'Respect', 'Distressed Animals'],
['Coachman', 'Moor', 'Scroll', 'Animated', 'Panic', 'The Glint of Metal'],
['Animal Tamer', 'Jungle', 'Medicine', 'Festering', 'Torment', 'Clean Soap'],
['Steward', 'Inn', 'Oil', 'Petrified', 'Death', 'Loud Chewing'],
['Demon', 'Outpost', 'Symbol', 'Bloody', 'Determined', 'Scrapping Wood'],
['Preacher', 'Carnival', 'Crystal', 'Dirty', 'Influence', 'Old Manure'],
['Traveler', 'Hot Spring', 'Rope', 'Frayed', 'Escort', 'Staccato Dripping'],
['Scribe', 'Camp', 'Ink', 'Mossy', 'Distract', 'Cloying Incense'],
['Guardian', 'Cave', 'Charm', 'Rare', 'Depart', 'A Medicinal Odor'],
['Peddler', 'Thicket', 'Crown', 'Crystallized', 'Slumber', 'Startled Birds'],
['Centaur', 'Chasm', 'Staff', 'Mechanical', 'Scheme', 'Scrapping Against Stone'],
['Refugee', 'Lighthouse', 'Gauntlet', 'Jagged', 'Suppress', 'Dark Chanting'],
['Bard', 'Island', 'Wedding', 'Silky', 'Freedom', 'A Tree Falling Nearby'],
['Archmage', 'Quarry', 'Lens', 'Transparent', 'Resist', 'An Inhuman Roar'],
['Goblin', 'Town', 'Horn', 'Uneven', 'Defend', 'Rotten Fruit'],
['Magistrate', 'Fjord', 'Warning', 'Buried', 'Devour', 'Distant Cheering'],
['Guard', 'Volcano', 'Ring', 'Golden', 'Investigate', 'Damp Clothing'],
['Fairy', 'Mine', 'Tea', 'Melted', 'Fascination', 'Sharp Pain'],
['Elder', 'Estate', 'Armor', 'Clockwork', 'Restore', 'A Shiver Down the Spine'],
['Charlatan', 'Redoubt', 'Bottle', 'Coated', 'Search', 'Cold Metal'],
['Beggar', 'Canyon', 'Law', 'Faded', 'Threat', 'Erratic Flashes ofLight'],
['Golem', 'Barrow', 'Chain', 'Colour-Changing', 'Acquire', 'A Pair of Eyes Watching'],
['Retired Hero', 'Crater', 'Festival', 'Lustrous', 'Passage', 'Fluttering Fabric'],
['Djinn', 'Shipwreck', 'Mask', 'Smooth', 'Command', 'Heavy Breathing'],
['Investigator', 'Station', 'Blood', 'Painted', 'Price', 'The Hiss of an Arrow'],
['Warrior', 'Tundra', 'Throne', 'Magical', 'Transform', 'Chirping Insects'],
['Druid', 'Meadow', 'Monster', 'Flowering', 'Hide', 'Dry, Crinkling Leaves'],
['Adventurer', 'Vault', 'Lantern', 'Heavy', 'Survival', 'Distant Fire Smoke'],
['Scientist', 'Fissure', 'Entrails', 'Elegant', 'Supply', 'Nearby Hoof Beats'],
['Squire', 'Sanctuary', 'Urn', 'Hollow', 'Fortify', 'A Thick, Pungent Broth'],
['Vigilante', 'Academy', 'Ritual', 'New', 'Battle', 'The Pop of Frying Food'],
['Apprentice', 'Orchard', 'Clock', 'Bleached', 'Corrupt', 'An Earthy Musk'],
['Hunter', 'Factory', 'Vial', 'Pliable', 'Defy', 'Charred Runes'],
['Diplomat', 'Highlands', 'Dream', 'Musical', 'Warning', 'The Swirl of Colourful Fabric'],
['Automaton', 'Laboratory', 'Skeleton', 'Restored', 'Duty', 'Coarse Fabric'],
['Courier', 'Labyrinth', 'Spell', 'Unknown', 'Truth', 'Soft Muttering'],
['Murderer', 'Mesa', 'Carving', 'Famous', 'Breach', 'A Heavy Fog'],
['Crime Boss', 'Dig Site', 'Ceremony', 'Lightweight', 'Surrender', 'Fresh Flowers'],
['Hermit', 'Church', 'Bow', 'Poisoned', 'Avoid', 'A Darting Shadow'],
['Performer', 'Stronghold', 'Mirror', 'Oozing', 'Gather', 'Liquid Sloshing'],
['Bounty Hunter', 'Spire', 'Funeral', 'Patterned', 'Deliver', 'Clouds of Dust'],
['Warlord', 'Lagoon', 'Emblem', 'Fragrant', 'Capture', 'A Low- Pitched Grinding'],
['Sage', 'College', 'Trap', 'Mind- Reading', 'Learn', 'The Bite of Strong Ale'],
['Explorer', 'Plateau', 'Potion', 'Incomprehensible', 'Honor', 'Dragging Through Mud'],
['Drunkard', 'Cathedral', 'Skull', 'Ordinary', 'Opportunity', 'The Aroma of Fine Wine'],
['Pilgrim', 'Stable', 'Constellation', 'Shattered', 'Knowledge', 'Slithering Against Your Skin'],
['Fisher', 'Shop', 'Grave', 'Overgrown', 'Reveal', 'Crashing Waves'],
['Inventor', 'Watchtower', 'Bracelet', 'Distinctive', 'Danger', 'Whispered Prayers'],
['Oracle', 'Refuge', 'Shipment', 'Smoldering', 'Challenge', 'Soggy, Uneven Ground'],
['Scout', 'Citadel', 'Bone', 'Gnarled', 'Manipulate', 'Running Water']

  
];


let data_event_meaning_action = [
  'Attainment', 'Starting', 'Neglect ', 'Fight', 'Recruit', 
  'Triumph', 'Violate', 'Oppose', 'Malice', 'Communicate', 
  'Persecute', 'Increase', 'Decrease', 'Abandon', 'Gratify', 
  'Inquire', 'Antagonise', 'Move', 'Waste', 'Truce', 
  'Release', 'Befriend', 'Judge', 'Desert', 'Dominate', 
  'Procrastinate', 'Praise', 'Separate', 'Take', 'Break', 
  'Heal', 'Delay', 'Stop', 'Lie', 'Return', 
  'Immitate', 'Struggle', 'Inform', 'Bestow', 'Postpone', 
  'Expose', 'Haggle', 'Imprison', 'Release', 'Celebrate', 
  'Develop', 'Travel', 'Block', 'Harm', 'Debase', 
  'Overindulge', 'Adjourn', 'Adversity', 'Kill', 'Disrupt', 
  'Usurp', 'Create', 'Betray', 'Agree', 'Abuse', 
  'Oppress', 'Inspect', 'Ambush', 'Spy', 'Attach', 
  'Carry', 'Open', 'Carelessness', 'Ruin', 'Extravagance', 
  'Trick', 'Arrive', 'Propose', 'Divide', 'Refuse', 
  'Mistrust', 'Deceive', 'Cruelty', 'Intolerance', 'Trust', 
  'Excitement', 'Activity', 'Assist', 'Care', 'Negligence', 
  'Passion', 'Work hard', 'Control', 'Attract', 'Failure', 
  'Pursue', 'Vengeance', 'Proceedings', 'Dispute', 'Punish', 
  'Guide', 'Transform', 'Overthrow', 'Oppress', 'Change' ];

let data_event_meaning_subject = [
  'Goals', 'Dreams', 'Environment', 'Outside', 'Inside', 
  'Reality', 'Allies', 'Enemies', 'Evil ', 'Good', 
  'Emotions', 'Opposition', 'War', 'Peace', 'The innocent', 
  'Love', 'The spiritual', 'The intellectual', 'New ideas', 'Joy', 
  'Messages', 'Energy', 'Balance', 'Tension', 'Friendship', 
  'The physical', 'A project', 'Pleasures', 'Pain', 'Possessions', 
  'Benefits', 'Plans', 'Lies', 'Expectations', 'Legal matters', 
  'Bureaucracy', 'Business ', 'A path', 'News', 'Exterior factors', 
  'Advice', 'A plot', 'Competition', 'Prison', 'Illness', 
  'Food', 'Attention', 'Success', 'Failure', 'Travel', 
  'Jealousy', 'Dispute', 'Home', 'Investment', 'Suffering', 
  'Wishes', 'Tactics', 'Stalemate', 'Randomness', 'Misfortune', 
  'Death', 'Disruption', 'Power', 'A burden', 'Intrigues', 
  'Fears', 'Ambush', 'Rumor', 'Wounds ', 'Extravagance', 
  'A representative', 'Adversities', 'Opulence', 'Liberty', 'Military', 
  'The mundane', 'Trials', 'Masses', 'Vehicle', 'Art', 
  'Victory', 'Dispute', 'Riches', 'Status quo', 'Technology', 
  'Hope', 'Magic', 'Illusions', 'Portals', 'Danger', 
  'Weapons', 'Animals', 'Weather', 'Elements', 'Nature', 
  'The public', 'Leadership', 'Fame', 'Anger', 'Information' ];


function tab_click(sender) {

  let $s = $(sender);

  $s.parent().find('.selected').removeClass('selected');
  $s.addClass('selected');

  if($s.attr('type') == 'oracle') {
    $('#oracle-result').attr('value', sender.value);

    return;
  }

  if($s.attr('type') == 'threads') {
    on_thread_tab_click(sender);
  }
}

function new_thread_click(sender) {

  let $s = $(sender);
  let $p = $s.parent();

  $p.find('.selected').removeClass('selected');


  let new_thread = thread_new();
  threads.push(new_thread );

  $s.attr('onclick', 'tab_click(this);');
  $s.attr('type', 'threads');
  $s.attr('id', new_thread.id);
  $s.html('Untitled');
  $s.addClass('selected');

  $p.append([
    '<button class="w3-bar-item w3-button button-item thread-tab"',
    'onclick="new_thread_click(this);">',
    'Add Thread',
    '</button>'
  ].join(''));

  thread_load(new_thread);

}

function on_thread_tab_click(sender) {
  console.log('loading ' + sender.id);

  $('#thread-details').attr('thread-id', sender.id);
  
  let t = get_current_thread();
  thread_load(t)
  
}

function thread_item_click(sender) {
  console.log('editing ' + sender.id);
  let $s = $(sender);
  let $p = $s.parent();
  let val = $s.html().trim();

  $s.addClass('hidden');

  let input = [
    '<input type="text" value="', val, '" ',
    'class="max-width"',
    'onblur="thread_item_edit_blur(this);"',
    'onkeypress="thread_item_edit_keypress(this, event);"',
    '/>'
  ];

  $p.append(input.join(''));
  let $in = $p.find('input');
  $in.focus();
  $in[0].setSelectionRange(val.length, val.length);
}

function thread_item_edit_blur(sender) {
  on_thread_edit_finish(sender);
}

function thread_item_edit_keypress(sender, event) {
  if(event.keyCode === 13){
    on_thread_edit_finish(sender);
  }
}

function on_thread_edit_finish(sender) {
  console.log('edit item lost focus');
  let $s = $(sender);
  let $p = $s.parent();

  let $v = $p.find('span');
  let text = $s.val().trim();
  $v.html( text.length == 0 ? 'untitled' : text );
  if($v.hasClass('hidden')) {
    $v.removeClass('hidden');
    $s.remove();
  }

  // var id = $('#thread-details').attr('thread-id');
  // let t = threads.find( (item) => {return item.id == id} );
  let t = get_current_thread();
  if(t) {
    t[$v.attr('field')] = text;
  }
}

function get_current_thread() {

  var id = $('#thread-details').attr('thread-id');
  let t = threads.find( (item) => {return item.id == id} );

  return t;
}

function thread_list_item_click(sender) {
  console.log('list item click');

  let $s = $(sender);
  let $p = $s.parent();
  let state = $s.attr('state');
  let index = Number($p.attr('index'));
  let thread = get_current_thread();
  let field = $p.parent().attr('field');
  
  if(state == 'crossed') {
    $s.removeClass('crossout');
    $s.attr('state', '');
    let $d = $p.find('.delete-item');
    $d.remove();
    thread[field][index].status = 0;
  }
  else {
    $s.addClass('crossout');
    $s.attr('state', 'crossed');
    let x = [ ' ',
      '<span class="delete-item pointer bold red" ',
      'onclick="thread_list_item_delete(this);"',
      '>X</span>'
    ];
    $p.append(x.join(''));
    thread[field][index].status = 1;
  }
}

function thread_list_item_delete(sender) {
  let $s = $(sender);
  let $p = $s.parent();

  // let $v = $p.find('span');

  let index = Number($p.attr('index')); // Number($v.attr('index'));

  let $pp = $p.parent();

  let t = get_current_thread();
  let field = $pp.attr('field');
  t[field][index] = null;


  $p.remove();
}

function thread_list_item_add(sender) {
  let $s = $(sender);
  let $p = $s.parent();
  let text = $s.html();

  $s.remove();

  let input = [
    '<input type="text" ',
    'class="max-width"',
    'onblur="thread_list_item_add_blur(this);"',
    'onkeypress="thread_list_item_add_keypress(this, event);"',
    '/>'
  ].join('');

  $p.append(input);

  let add_item = ['<li>',
    '<span command="add-question" ',
    'class="pointer" ',
    'onclick="thread_list_item_add(this);">',
    text,
    '</span></li>'].join('');

  $p.parent().append(add_item);

  let $in = $p.find('input');
  $in.focus();
  $in[0].setSelectionRange(0, 0);
}

function thread_list_item_add_blur(sender) {
  on_thread_list_item_add_finish(sender);
}

function thread_list_item_add_keypress(sender, event) {
  if(event.keyCode === 13){
    on_thread_list_item_add_finish(sender);
  }
}

function on_thread_list_item_add_finish(sender) {
  let $s = $(sender);
  let $p = $s.parent();
  
  let text = $s.val().trim();

  if(text.trim().length == 0) {
    $p.remove();
    return;
  }
  
  if($p.find('span').length == 0) {
    let span = [ '<span ',
      'class="pointer" ',
      'onclick="thread_list_item_click(this);">',
      text,
      '</span></li>'].join('');

    $p.append(span);

    $s.remove();
    
    $pp = $p.parent();
    let field = $pp.attr('field');
    let t = get_current_thread();
    if(t) {
      if(t[field] == null) {
        t[field] = [];
      }

      let index = t[field].length;
      t[field].push(text);
      $p.find('span').attr('index', index); 
    }

  }
}


function oracle_query(scene, surge, roll, roll_unexpected) {

  let r = roll;
  if(r == null)
    r = dice(100);

  console.log(r);

  if(r <= 50) {
    r -= surge;
  }
  else {
    r += surge;
  }
  if(r < 1) r = 1;
  if(r > 100) r = 100;


  let result = null;
  let data = data_oracle_loom;
  let result_enum = {
    NO_AND_UNEXPECED: 1,
    NO_BUT: 2,
    NO_AND: 3,
    NO: 4,
    YES: 5,
    YES_AND: 6,
    YES_BUT: 7,
    YES_AND_UNEXPECED: 8,

  };
  let i = 1;
  for(i = 1; i <= data.length - 1; ++i) {
    let current = data[i];
    let range_check = current[0][scene];
    if(range_check[0] <= r && r <= range_check[1]) {
      result = current;
      break;
    }
  }

  let unexpected = null;
  if(i == result_enum.NO_AND_UNEXPECED || i == result_enum.YES_AND_UNEXPECED) {
    let unex_data = data_oracle_crge_unexpected;
    let d = roll_unexpected || dice(unex_data.length - 1);
    let unex = unex_data[d];
    unexpected = {
      result: d,
      text: unex[0],
      hint: unex[1]
    };
  }

  if(i == result_enum.YES || i == result_enum.NO) {
    surge += 2;
  }
  else {
    surge = 0;
  }

  let images = null;
  if(i == result_enum.YES_AND || i == result_enum.YES_BUT ||
     i == result_enum.NO_AND || i == result_enum.NO_BUT ) {

    images = [];
    let n = dice(5);
    let icons = data_icons_actions;
    for(let i = 0; i < n; ++i) {
      images.push(icons[dice(icons.length - 1)]);
    }
  }



  $('#oracle-result').attr('surge', surge);
  $('#oracle-surge').html(surge);

  return {
      roll: roll,
      result: i,
      text: result[1],
      images: images,
      unexpected: unexpected
  };

}

function oracle_result_contents_click(sender) {
  

  let action = function() {
    let scene = $('#oracle-result').attr('value');
    let surge = $('#oracle-result').attr('surge');

    let result = oracle_query(Number(scene), Number(surge));
    let text = [
      '<span>', result.text, '</span> ',
      '<span>', result.unexpected?.text || '', '</span> ',
    ];

    let images = null;
    if(result.images != null) {
      images = [];
      for(let i = 0; i < result.images.length; ++i) {
        images.push(
          [ '<span class="oracle-result-image">',
            '<img width="45" height="45" src="',
            result.images[i],
            '"/>',
            '</span>'
          ].join('')
        );
      }
    }

    $(sender).html(text.join('') + (images?.join('') || ''));
    $('#oracle-result-contents-hint').html(result.unexpected?.hint || '');
  };


  sender.innerHTML = '<img src="img/spinner.svg" width="45" height="45" />';

  setTimeout(function() {
    action();
  }, dice(750) + 250);

}

function plot_hook(r1, r2, r3, r4, r5, r6) {

  let data = data_plot_hooks;

  let rolls = [ r1, r2, r3, r4, r5, r6 ];

  let init = function(v) {
    if(v == null) {
      return dice(data.length - 1);
    }
    return v;
  }

  for(let i = 0; i < rolls.length; ++i) {
    rolls[i] = init(rolls[i]);
  }
  
  let results = [];
  for(i = 0; i < rolls.length; ++i) {
    let r = data_lookup_single(data, rolls[i]);
    results.push([
      '<span>', r.result[i], '</span> '
    ].join(''));
  }

  return results.join('');
}


function thread_load(thread) {

  if(thread == null)
    return;

  clear_thread_contents();

  $('#thread-details').attr('thread-id', thread.id);
  $('#thread-title').html(thread.title);
  $('#thread-description').html(thread.description);

  let prepend_new_li = function($element, i, crossed, text) {
    
    let x = '';
    if(crossed) {
      x = [ ' ',
        '<span class="delete-item pointer bold red" ',
        'onclick="thread_list_item_delete(this);">',
        'X',
        '</span>'
      ].join('');
    }

    let li = [ 
      '<li class="thread-list-item" index="',
      i,
      '"><span class="pointer ',
      crossed ? 'crossout' : '',
      '"' ,
      'onclick="thread_list_item_click(this);" ', 
      crossed ? 'state="crossed"' : '',
      '>',
      text,
      '</span>',
      x,
      '</li>'].join('');

    $element.prepend(li);
  }

  if(thread.facts) {
    let facts = thread.facts.filter((element) => {return element != null});
    thread.facts = facts;
    let $q = $('#thread-facts');
    let data = thread.facts;
    for(let i = data.length - 1; i >= 0; i--) {
      let current = data[i];
      prepend_new_li($q, i, current.status, current.text);
    }
  }

  if(thread.questions) {
    let questions = thread.questions.filter((element) => {return element != null});
    thread.questions= questions;
    let $q = $('#thread-questions');
    let data = thread.questions;
    for(let i = data.length - 1; i >= 0; i--) {
      let current = data[i];
      prepend_new_li($q, i, current.status, current.text);
    }
  }
}

function clear_thread_contents() {
  let text_ids = [
    '#thread-title',
    '#thread-description'
  ];

  for(i = 0; i < text_ids.length; ++i) {
    $(text_ids[i]).html('untitled');
  }

  $('.thread-list-item').remove();
  $('.character-list-item').remove();
  $('.scene-list-item').remove();
}

let threads = [];

function on_load() {
  // threads.push(thread_new());

  // thread_load(threads[0]);
}

on_load();

    </script>

</html>
