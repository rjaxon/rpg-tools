<!DOCTYPE html>
<html lang="en">
    <head>
        <title>
            RJ's RPG Tools - Oracle
        </title>

        <link rel="icon" href="img/icons/ffffff/000000/1x1/delapouite/dice-twenty-faces-twenty.svg">

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

        <link href="css/dice.css" rel="stylesheet">

        <script src="scripts/util.js"></script>
        <!--script type="module" src="scripts/dice.js"></script-->
        <script src="scripts/dice.js"></script>
        <script src="scripts/data.js"></script>
        <script src="scripts/data/icons.js"></script>
        <script src="scripts/data/oracle.js"></script>

        <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.6.2.min.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">

    </head>
<style>

    ul {
      margin-bottom: 0px;
    }

    textarea {
        resize: none;
        width: 100%;
        height: 100%;
        border: 0px;
    }

    textarea:hover {
        border: none; /* Removes the border */
        outline: none; /* Removes the outline */
    }

    .hidden {
        display: none;
    }

    .label {
      font-weight: bold;
    }

    .pointer {
      cursor: pointer;
    }

    .red {
      color: red;
    }

    .bold {
      font-weight: bold;
    }

    .crossout {
      text-decoration: line-through;
    }

    .max-width {
      width: 100%;
    }

    .pad-10px {
      padding: 10px;
    }

    .align-right {
      text-align: right;
    }


    .button-item {
      border-radius: 5px;
      border-bottom-left-radius: unset;
      border-bottom-right-radius: unset;
      border-bottom-color: white;
      width: 100px;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
    }

    .oracle-scene-stage {
      width: 120px;
    }

    .thread-tab {
      margin-right: 5px;
    }

    button.selected {
      background: white;
      border: 2px solid black;
      border-bottom-color: white;
      position: relative;
      top: 2px;
    }

    #oracle-container {
      padding: 1em;;
    }
    
    #oracle {
    }

    #oracle-result {
      border-radius: 5px;
      border-top-left-radius: unset;
      padding: 2em;
      font-weight: bold;
      font-size: 2em;
      text-align: center;
      border-left: 2px solid black;
      border-right: 2px solid black;
      border-top: 2px solid black;
      border-bottom-left-radius: unset;
      border-bottom-right-radius: unset;
    }

    #oracle-result-contents-hint {
      border-left: 2px solid black;
      border-right: 2px solid black;
      border-bottom: 2px solid black;
      border-radius: 5px;
      border-top-left-radius: unset;
      border-top-right-radius: unset;
      padding-left: 1em;
      padding-right: 1em;
      padding-bottom: 1em;
      text-align: center;
    }

    #oracle-result-contents {
      cursor: pointer;
    }

    .oracle-result-image {
      padding: 5px;
    }


    .oracle-scene-stage-item {
      border: 1px solid black;
    }

/*********************************/


  #thread-container {
    padding: 1em;
  }

  #thread-details {
    border-top: 2px solid black;
    border-left: 2px solid black;
    border-right: 2px solid black;
    border-radius: 5px;
    border-top-left-radius: unset;
    border-bottom-left-radius: unset;
    border-bottom-right-radius: unset;
  }

  #thread-details-contents {
    padding: 10px;
  }

  #thread-details-contents-input {
    height: 300px;
  }

  #threads-footer {
    height: 2.5em;
    text-align: right;
    padding-right: 10px;
    padding-left: 10px;
    border-bottom: 2px solid black;
    border-left: 2px solid black;
    border-right: 2px solid black;

    border-radius: 5px;
    border-top-left-radius: unset;
    border-top-right-radius: unset;
  }

  #thread-scene {
  }

  #thread-scene-title {
      padding: 10px;
      text-align: center;
      font-weight: bold;
      border-bottom: 2px solid black;
  }

  #thread-scene-log {
    height: 500px;
    overflow-y: scroll;
    padding-bottom: 10px;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
  
  /* Apply the animation to an element */
  .fade-in {
    animation-name: fadeIn;
    animation-duration: 2s; /* Duration of the animation */
    animation-timing-function: ease-in; /* Smooth transition */
  }


  .thread-log-system {
    text-align: center;
    font-weight: bold;
    padding-bottom: 10px;
    padding: 10px;
    margin-left: 20%;
    margin-right: 20%;
    border: 1px solid #ccc;

    animation-name: fadeIn;
    animation-duration: 3s; /* Duration of the animation */
    animation-timing-function: ease-in; /* Smooth transition */

    .oracle-result-image {
      img {
        width: 40px;
      }
      img:active{
        width: 50px;
      }
      img:active{
        width: 100px;
      }
    }
    
  }

  .thread-log-gm {
    color: green;
    padding-top: 2px;
    padding-bottom: 2px;
    padding-left: 5px;
    background: #e4e4e4;
  }

  .thread-log-player {
    color: blue;
    text-align: right;
    background: #eee;
    border-radius: 5px;
    padding-top: 2px;
    padding-bottom: 2px;
    padding-right: 5px;
  }


</style>

<body>

  <div id="oracle-container">
    <div id="oracle">
       <div id="oracle-surge" class="hidden">0</div>
        <div class="row">
            <div class="col-12">
              <div class="w3-bar w3-black">
                <button type="oracle" class="w3-bar-item w3-button button-item oracle-scene-stage selected" value="1" onclick="tab_click(this);">To Knowledge</button>
                <button type="oracle" class="w3-bar-item w3-button button-item oracle-scene-stage" value="2" onclick="tab_click(this);">To Conflict</button>
                <button type="oracle" class="w3-bar-item w3-button button-item oracle-scene-stage" value="3" onclick="tab_click(this);">To Endings</button>
              </div>
            </div>
            <div class="col-sm">
                <div id="oracle-result" value="1" surge="0">
                  <div id="oracle-result-contents" onclick="oracle_result_contents_click(this);">
                    Click here to query the loom of fate 
                  </div>
                </div>
            </div>
            <div class="col-12">
                  <div id="oracle-result-contents-hint"> </div>
            </div>
        </div>
    </div>
  </div>

  <div id="thread-container">
    <div id="threads">
      <div class="row">
        <div id="thread-tabs" class="col-12 ">
            <!--button id="a-guid-001" type="threads" class="w3-bar-item w3-button button-item oracle-scene-stage selected" onclick="tab_click(this);">Thread 1</button>
            <button id="a-guid-001" type="threads" class="w3-bar-item w3-button button-item thread-tab" onclick="tab_click(this);">Thread 2</button>
            <button id="a-guid-001" type="threads" class="w3-bar-item w3-button button-item thread-tab" onclick="tab_click(this);">Thread 3</button>
            <button id="a-guid-001" type="threads" class="w3-bar-item w3-button button-item thread-tab" onclick="tab_click(this);">Thread 4</button-->
            <button  class="w3-bar-item w3-button button-item " onclick="thread_init(adventure.create_thread());">Add Thread</button>
        </div>

        <div class="col-sm">
            <div id="thread-details">
              <div id="thread-details-contents" class="">
                <div class="row">
                  <div id="thread-title" field="title" >
                    <span class="col-12 label pointer editable" onclick="thread_item_click(this);">Thread 1 Long Title</span>
                  </div>

                  <div class="col-12 label">Description</div>
                  <div id="thread-description" field="description" class="col-12">
                    <span class="pointer editable"  onclick="thread_item_click(this);")>
                    We were hired to find the victim and the kidnapper.
                    </span>
                  </div>
                  <div class="col-12 label">Facts</div>
                  <div class="col-12">
                      <ul id="thread-facts" field="facts">
                        <li class="thread-list-item"><span class="pointer" onclick="thread_list_item_click(this);">The mother was not around during the incident</span></li>
                        <li class="thread-list-item"><span class="pointer" onclick="thread_list_item_click(this);">The victim was trying to meet someone</span></li>
                        <li class="thread-list-item"><span class="pointer" onclick="thread_list_item_click(this);">The victom is male</span></li>
                        <li><span command="add-fact" class="pointer" onclick="thread_list_item_add(this);">Add Fact</span></li>
                      </ul>
                  </div>
                  <div class="col-12 label">Questions / Rumors</div>
                  <div class="col-12">
                      <ul id="thread-questions" field="questions">
                        <li class="thread-list-item" index="0"><span class="pointer" onclick="thread_list_item_click(this);">Where was the mother?</span></li>
                        <li class="thread-list-item" index="1"><span class="pointer" onclick="thread_list_item_click(this);">What is the victim's name?</span></li>
                        <li class="thread-list-item" index="2"><span class="pointer" onclick="thread_list_item_click(this);">Who was the victim trying to meet?</span></li>
                        <li><span command="add-question" class="pointer" onclick="thread_list_item_add(this);">Add Question</span></li>
                      </ul>
                  </div>

                  <div class="col-12 label">Notable Characters</div>
                  <div class="col-sm character-list-item">Character Name 1</div>
                  <div class="col-sm character-list-item">Character Name 2</div>
                  <div class="col-sm character-list-item">Character Name 3</div>
                  <div class="col-sm character-list-item">Character Name 4</div>
                  <div class="col-sm">Add Existing NPC</div>

                  <div class="col-12">
                      <div class="label">Scenes</div>
                      <ul id="thread-scene-list" >
                        
                      </ul>
                      <div class="col-sm scene-list-item">Scene 1</div>
                      <div class="col-sm scene-list-item">Scene 2</div>
                      <div class="col-sm scene-list-item">Scene 3</div>
                      <div class="col-sm scene-list-item">Scene 4</div>
                      <div class="col-sm scene-list-item">Scene 5</div>
                  </div>
                  <div class="col-sm pointer" onclick="add_scene_click();">Add Scene</div>
                </div>
              </div>
              <div id="thread-scene" class="hidden" >
                <div id="thread-scene-title" class="label center">
                    <span>Scene Title Here</span>
                </div>                  
                <div id="thread-scene-log" class="col-12">
                </div>
                <div id="thread-scene-input" class="col-12 pad-10px" style="border-top: 2px solid black;">
                  <div class="row">
                    <div class="col-6 char-tab-container">
                      <button type="scene-button" log_type="1" userid="gm-001"     class="w3-bar-item w3-button char-tab button-item selected" value="1" onclick="thread_scene_input_tab_click(this);">GM</button>
                      <button type="scene-button" log_type="2" userid="001" class="w3-bar-item w3-button char-tab button-item " value="1" onclick="thread_scene_input_tab_click(this);">Sullivan</button>
                    </div>
                    <div class="col-6 align-right">
                    </div>
                    <div class="col-12">
                      <input type="text" class="max-width" onkeypress="thread_scene_input_keypress(this, event)" />
                    </div>
                  </div>
                </div>
              </div>
            </div>
        </div>

        <div class="col-12">
            <div id="threads-footer">
              <div>
                <span id="thread-footer-buttons" class="">
                  <button>Edit</button>
                  <button>Ok</button>
                </span>
              </div>
              <div  id="thread-footer-scene-buttons" class="hidden">
                  <div class="row">
                <div class="col-6" style="text-align: left;">
                    <div id="gm-buttons">
                        <button id="query-oracle" type="query-oracle" class="" value="1" onclick="scene_oracle_query_click();">Query Oracle</button>
                    </div>
                    <div id="player-buttons" class="hidden">
                        <button>Roll 20</button>
                    </div>
                </div>
                <div class="col-6">
                  <span>
                    <button onclick="thread_end_scene();">End Scene</button>
                  </span>
                </div>
                  </div>
              </div>
            </div>
        </div>

      </div>
    </div>
  </div>



</body>


    <!--script type="module"-->
    <script type="text/javascript">

// import {dice, dice_n, fudge} from './scripts/dice.js';
// 
// console.log(fudge());

class Oracle {

  constructor() {
    this.surge = 0;
    this.scene = 1;
    this.history_max = 20;
    this.history = [];
    this.expectations = data_oracle_crge_unexpected;

    this.query = oracle_query;

    // result: {...}
    this.on_query_result = [];

    // result: new_surge_value
    this.on_set_surge = [];
  }


  // callback(oracle, roll_result)
  add_on_query_result_observer(callback) {
    this.on_query_result.push(callback);
  }

  add_on_set_surge_observer(callback) {
    this.on_set_surge.push(callback);
  }

  set_surge(s) {
    this.surge = s;
    this.on_set_surge.forEach( callback => { callback(this.surge); } );
  }
};


function oracle_query(_scene, _surge, roll, roll_unexpected) {

  if(this.constructor.name != 'Oracle') { return; }

  let surge = this.surge; 
  let scene = this.scene;

  let r = roll;
  if(r == null)
    r = dice(100);

  if(r <= 50) {
    r -= surge;
  }
  else {
    r += surge;
  }
  if(r < 1) r = 1;
  if(r > 100) r = 100;


  let result = null;
  let data = data_oracle_loom;
  let result_enum = {
    NO_AND_UNEXPECTED: 1,
    NO_BUT: 2,
    NO_AND: 3,
    NO: 4,
    YES: 5,
    YES_AND: 6,
    YES_BUT: 7,
    YES_AND_UNEXPECTED: 8,

  };
  let i = 1;
  for(i = 1; i <= data.length - 1; ++i) {
    let current = data[i];
    let range_check = current[0][scene];
    if(range_check[0] <= r && r <= range_check[1]) {
      result = current;
      break;
    }
  }

  let unexpected = null;
  if(i == result_enum.NO_AND_UNEXPECTED || i == result_enum.YES_AND_UNEXPECTED) {
    let unex_data = data_oracle_crge_unexpected;
    let d = roll_unexpected || dice(unex_data.length - 1);
    let unex = unex_data[d];
    unexpected = {
      result: d,
      text: unex[0],
      hint: unex[1]
    };
  }

  if(i == result_enum.YES || i == result_enum.NO) {
    surge += 2;
  }
  else {
    surge = 0;
  }

  this.set_surge(surge);

  let images = null;
  if(i == result_enum.YES_AND || i == result_enum.YES_BUT ||
     i == result_enum.NO_AND || i == result_enum.NO_BUT ) {

    images = [];
    let n = dice(5);
    let icons = data_icons_actions;
    for(let i = 0; i < n; ++i) {
      images.push(dice(icons.length - 1));
    }
  }

  let roll_result = {
      roll: r,
      result: i,
      text: result[1],
      images: images,
      unexpected: unexpected
  };
  
  if(this.history_max != 0 && this.history_max <= this.history.length ) {
    this.history.shift();
  }
  this.history.push(roll_result);

  this.on_query_result.forEach( (func) => { func(this, roll_result) } );
}

class Character {

  id;
  name;
  type;

  constructor(id, name, type) {
    this.id = id || crypto.randomUUID();
    this.name = name || '';
    this.type = type || 1;
  }
}

class Adventure {

  #id;

  #characters;

  #active_thread;


  constructor() {
    this.#id = crypto.randomUUID();
    this.#characters = [];

    this.#characters.push(new Character('gm-001', 'GM', 1));
    this.#characters.push(new Character(crypto.randomUUID(), 'Sullivan', 2))

    this.title = 'Untitled';
    this.description= '';

    this.threads = [];
    
    this.on_title_change = [];
    this.on_description_change = [];
    this.on_thread_add = [];
    this.on_thread_active = [];
  }

  get id() {
    return this.#id;
  }

  set id(_value) {
    throw new Error('Not Implemented');
  }

  get characters() {
    return this.#characters;
  }

  get active_thread() {
    return this.#active_thread;
  }

  set active_thread(thread) {
    if(thread == null) return;
    if(this.active_thread && (this.active_thread.id == thread.id)) {
      return;
    }

    this.#active_thread = thread;
    this.on_thread_active.forEach( (func) => func(thread) );
  }

  set_title(title) {
    this.title = title;
    this.on_title_change.forEach((func) => func(this) );
  }

  set_description(description) {
    this.description = description;
    this.on_description_change.forEach((func) => func(this.description) );
  }

  get_thread(thread_id) {
    let t = this.threads.find( (item) => {return item.id == thread_id} );
    return t;
  }


  create_thread() {
    let t = new Thread();
    this.threads.push(t);
    this.on_thread_add.forEach( (func) => func(t) );
    return t;
  }
}

function adventure_observer_on_thread_add(new_thread) {
  console.log(new_thread);

  $('.thread-tab.selected').removeClass('selected');

  let button = ['<button id="',
    new_thread.id, '" ',
    'type="threads" ',
    'class="w3-bar-item w3-button button-item thread-tab selected"',
    'onclick="tab_click(this);">',
    new_thread.title,
    '</button>'].join('');

  let threads = adventure.threads;
  if($('#thread-tabs').find('.thread-tab').length == 0) {
    $('#thread-tabs').prepend(button);
  }
  else {
    let last = threads[threads.length - 2];
    $(button).insertAfter($('#'+last.id));
  }

  thread_load(new_thread);
}

function adventure_observer_on_thread_active(thread) {
  console.log('thread active ' + thread.id);
  $('#thread-details').attr('thread-id', thread.id);
  thread_load(thread);
}

class ListItem {

  constructor(status, text) {
    this.status = status;
    this.text = text;
  }

}

class Thread {

  #id;
  #title;
  #description;
  #active_scene;

  constructor() {
    this.#id= crypto.randomUUID();
    this.#title= 'Untitled';
    this.#description= '';

    this.facts= [];
    this.questions= [];

    this.characters= [];
    this.scenes= [];

    this.on_title_change = [];
    this.on_description_change = [];

    this.on_list_item_toggle = [];

    // this.on_facts_add = [];
    // this.on_questions_add = [];
    this.on_list_item_add = []; // fact / question added
    this.on_characters_add = [];
    this.on_scene_add = [];
    this.on_active_scene_change = [];
  }

  get id() {
    return this.#id;
  }

  get title() {
    return this.#title;
  }

  set active_scene(scene) {
    this.#active_scene = scene;

    this.on_active_scene_change.forEach( (func) => func(scene) );
  }
    
  get active_scene() {
    return this.#active_scene;
  }

  set title(_title) {
    if(this.#title == _title) return;
    this.#title = _title;
    this.on_title_change.forEach((func) => func(this) );
  }

  get description() {
    return this.#description;
  }

  set description(_description) {
    if(this.#description == _description) return;
    this.#description = _description;
    this.on_description_change.forEach((func) => func(this.#description) );
  }

  add_fact(text) {
    if(0 == text.trim().length) return;

    this.facts.push(new ListItem(0, text));
    
    this.on_list_item_add.forEach( (func) => func(this, 'fact') );
  }

  add_question(text) {
    if(0 == text.trim().length) return;

    this.questions.push(new ListItem(0, text));
    
    this.on_list_item_add.forEach( (func) => func(this, 'question') );
  }

  create_scene(initial_characters) {
    let s = new Scene();
    
    if(initial_characters) {
      initial_characters.forEach( (c) => s.add_character(c) );
      s.set_active_user(initial_characters[0].id);
    }

    this.scenes.push(s);

    this.on_scene_add.forEach((func) => func(s) );
    return s;
  }

  toggle_list_item(field, index) {

    let item = this[field][index];
    if(item == null) return;

    item.status = item.status == 0 ? 1 : 0;

    this.on_list_item_toggle.forEach( (func) => func(field, index) );
  }
}

function thread_observer_on_scene_add(new_scene) {
  console.log('new_scene');

  let li = dom_item_new('li');
  let span = span_new(new_scene.id, new_scene.name, 'col-sm pointer scene-list-item');
  li.append(span);
    
  $(span).attr('onclick', 'scene_click(this);');

  $('#thread-scene-list').append(li);
    //<div class="col-sm scene-list-item">Scene 3</div>

  console.log(new_scene);
}

function thread_observer_on_title_change(thread) {

  if(thread.id == adventure.active_thread.id) {
    $('#thread-title').find('span').html(thread.title);
  }
  $('#'+thread.id).html(thread.title);
}

function thread_observer_on_description_change(new_value) {
  $('#thread-description').find('span').html(new_value);
}

function thread_observer_on_question_or_fact_add(thread, listname) {

  if(adventure.active_thread.id != thread.id) return;

  if(listname == 'fact') {
    add_list_item(thread.facts, 'thread-facts');
  }
  else if(listname == 'question') {
    add_list_item(thread.questions, 'thread-questions');
  }
}

function thread_observer_on_list_item_toggle(field, index) {

  let $span = $('*[field=' + field + ']').find('li *[index=' + index + ']');

  if(adventure.active_thread[field][index].status) {
    $span.addClass('crossout');
    add_thread_item_delete_button($span.parent());
  }
  else {
    $span.removeClass('crossout');
    $span.parent().find('.delete-item').remove();
  }
}

function thread_observer_on_active_scene_change(scene) {
  if(scene == null) return;
  // $('#thread-scene-list').find('#' + scene.id).html(scene.name); 
  $('#thread-scene-title').find('span').html(scene.name);

  $('#thread-scene').removeClass('hidden');
  $('#thread-footer-scene-buttons').removeClass('hidden');
  
  $('#thread-details-contents').addClass('hidden');
  $('#thread-footer-buttons').addClass('hidden');
  $('#thread-tabs').addClass('hidden');

  $('.char-tab').remove();
  
  let button = function (id, name, type, css_class) { 
    return ['<button type="scene-button" ',
    'log_type="', type, '" ',
    'userid="', id, '" ',
    'class="w3-bar-item w3-button char-tab button-item ',
    css_class, '" ',
    'value="', type, '" onclick="thread_scene_input_tab_click(this);">', 
    name,
    ,'</button>' ].join('') 
  };
  let $char_tab_container = $('.char-tab-container');
  scene.characters.forEach( (c, i) => {
    let b = button(c.id, c.name, c.type, i == 0 ? 'selected': '');
    $char_tab_container.append(b);
  });
}

function add_thread_item_delete_button($element) {
  let x = [ ' ',
    '<span class="delete-item pointer bold red" ',
    'onclick="thread_list_item_delete(this);"',
    '>X</span>'
  ].join('');

  $element.append(x);
}

function add_list_item(list, list_id) {

  let added_list_item = list[list.length - 1];

  let $ul = $('#' + list_id);
  let span = [ '<li class="thread-list-item"><span ',
    'class="pointer" ',
    'onclick="thread_list_item_click(this);" ',
    'index="', list.length - 1, '"',
    '>',
    added_list_item.text,
    '</span></li>'].join('');

  if(0 == $ul.find('.thread-list-item').length) {
    $ul.prepend(span);
  }
  else {
    $(span).insertAfter($ul.find('li.thread-list-item').last() );
  }
}


function tab_click(sender) {

  let $s = $(sender);

  $s.parent().find('.selected').removeClass('selected');
  $s.addClass('selected');

  if($s.attr('type') == 'oracle') {
    $('#oracle-result').attr('value', sender.value);

    return;
  }

  if($s.attr('type') == 'threads') {
    adventure.active_thread = adventure.get_thread(sender.id);
  }
}

function new_thread_click(sender) {

}

function add_scene_click() {

  let starting_chars = adventure.characters;

  let scene = adventure.active_thread.create_scene(starting_chars);
  scene_init(scene);
}

function scene_click(sender) {
  console.log('scene click');
  // $('#thread-scene').removeClass('hidden');
  // $('#thread-footer-scene-buttons').removeClass('hidden');
  // 
  // $('#thread-details-contents').addClass('hidden');
  // $('#thread-footer-buttons').addClass('hidden');
  // $('#thread-tabs').addClass('hidden');

  // $('.char-tab').remove();

  adventure.active_thread.active_scene = 
        adventure.active_thread.scenes.find( (e) => {return e.id == sender.id});

  let chars = adventure.characters;
  adventure.active_thread.active_scene.set_active_user(chars[0].id);
}

function on_thread_tab_click(sender) {
  console.log('loading ' + sender.id);

  $('#thread-details').attr('thread-id', sender.id);
  
  let t = get_current_thread();
  thread_load(t)
  
}

function thread_item_click(sender) {
  console.log('editing ' + sender.id);
  let $s = $(sender);
  let $p = $s.parent();
  let val = $p.find('span').html().trim();

  $p.find('span').addClass('hidden');

  let input = [
    '<input type="text" value="', val, '" ',
    'class="max-width"',
    'onblur="thread_item_edit_blur(this);"',
    'onkeypress="thread_item_edit_keypress(this, event);"',
    '/>'
  ];

  $p.append(input.join(''));
  let $in = $p.find('input');
  $in.focus();
  $in[0].setSelectionRange(val.length, val.length);
}

function thread_item_edit_blur(sender) {
  on_thread_edit_finish(sender);
}

function thread_item_edit_keypress(sender, event) {
  if(event.keyCode === 13){
    on_thread_edit_finish(sender);
  }
}

function on_thread_edit_finish(sender) {
  let $s = $(sender);
  let $p = $s.parent();

  let $v = $p.find('span');
  let text = $s.val().trim();

  if($v.hasClass('hidden')) {
    $v.removeClass('hidden');
    $s.remove();
  }

  let thread_id = $('#thread-details').attr('thread-id');
  let t = adventure.threads.find( (t) => {return t.id == thread_id} );
  if(t[$p.attr('field')] != text) {
    t[$p.attr('field')] = text;
  }
}

function get_current_thread() {

  var id = $('#thread-details').attr('thread-id');
  let t = threads.find( (item) => {return item.id == id} );

  return t;
}

function thread_list_item_click(sender) {

  let $s = $(sender);
  let $p = $s.parent();
  let $pp = $p.parent();

  let field = $pp.attr('field');
  let index = Number($s.attr('index'));

  let thread = adventure.active_thread;
  thread.toggle_list_item(field, index);
}


function thread_list_item_delete(sender) {
  let $s = $(sender);
  let $p = $s.parent();
  let $pp = $p.parent();

  $p.remove();

  // let index = Number($p.attr('index'));


  // let t = get_current_thread();
  let thread = adventure.active_thread;
  // let field = $pp.attr('field');
  let field = $pp.attr('field');
  let index = Number($p.find('span').attr('index'));
  thread[field][index] = null;


}

function thread_list_item_add(sender) {
  let $s = $(sender);
  let $p = $s.parent();
  let text = $s.html();

  $s.addClass('hidden')

  let input = [
    '<input type="text" ',
    'class="max-width"',
    'command="', $s.attr('command'), '" ',
    'onblur="thread_list_item_add_blur(this);"',
    'onkeypress="thread_list_item_add_keypress(this, event);"',
    '/>'
  ].join('');

  $p.append(input);

  let $in = $p.find('input');
  $in.focus();
  $in[0].setSelectionRange(0, 0);
}

function thread_list_item_add_blur(sender) {
  on_thread_list_item_add_finish(sender);
}

function thread_list_item_add_keypress(sender) {
  if(event.keyCode === 13){

    $(sender).remove();
  }
}

function on_thread_list_item_add_finish(sender, enter_pressed) {

  let $s = $(sender);
  let $p = $s.parent();

  let command = $s.attr('command');

  if(command == 'add-fact') {
    adventure.active_thread.add_fact($s.val() );
  }
  else if(command == 'add-question') {
    adventure.active_thread.add_question($s.val() );
  }

  $p.find('span').removeClass('hidden');
}

function oracle_observer_set_surge(value) {
  console.log('surge: ' + value);
}

function oracle_observer_query_result(oracle, result) {

  let action = function() {
    let scene = oracle.scene;
    let surge = oracle.surge;

    let text = [
      '<span>', result.text, '</span> ',
      '<span>', result.unexpected?.text || '', '</span> ',
    ];

    let images = null;
    let icons = data_icons_actions;
    if(result.images != null) {
      images = [];
      for(let i = 0; i < result.images.length; ++i) {
        images.push(
          [ '<span class="oracle-result-image">',
            '<img width="45" height="45" src="',
            icons[result.images[i]],
            '"/>',
            '</span>'
          ].join('')
        );
      }
    }

    _('oracle-result-contents').innerHTML = text.join('') + (images?.join('') || '');
    $('#oracle-result-contents-hint').html(result.unexpected?.hint || '');
  };

  _('oracle-result-contents').innerHTML = '<img src="img/spinner.svg" width="45" height="45" />';

  setTimeout(function() {
    action();
  }, dice(750) + 250);

}

function oracle_result_contents_click(sender) {
  
  oracle.query();

}

function plot_hook(r1, r2, r3, r4, r5, r6) {

  let data = data_plot_hooks;

  let rolls = [ r1, r2, r3, r4, r5, r6 ];

  let init = function(v) {
    if(v == null) {
      return dice(data.length - 1);
    }
    return v;
  }

  for(let i = 0; i < rolls.length; ++i) {
    rolls[i] = init(rolls[i]);
  }
  
  let results = [];
  for(i = 0; i < rolls.length; ++i) {
    let r = data_lookup_single(data, rolls[i]);
    results.push([
      '<span>', r.result[i], '</span> '
    ].join(''));
  }

  return results.join('');
}


function thread_load(thread) {

  if(thread == null)
    return;

  clear_thread_contents();

  adventure.active_thread = thread;
  $('#thread-details').attr('thread-id', thread.id);
  $('#'+thread.id).html(thread.title || 'untitled');

  $('#thread-title').find('span').html( thread.title || 'untitled');
  $('#thread-description').find('span').html(thread.description || 'No Description');

  let prepend_new_li = function($element, i, crossed, text) {
    
    let x = '';
    if(crossed) {
      x = [ ' ',
        '<span class="delete-item pointer bold red" ',
        'onclick="thread_list_item_delete(this);">',
        'X',
        '</span>'
      ].join('');
    }

    let li = [ 
      '<li class="thread-list-item" index="',
      i,
      '"><span class="pointer ',
      crossed ? 'crossout' : '',
      '"' ,
      'onclick="thread_list_item_click(this);" ', 
      crossed ? 'state="crossed"' : '',
      '>',
      text,
      '</span>',
      x,
      '</li>'].join('');

    $element.prepend(li);
  }

  if(thread.facts) {
    let facts = thread.facts.filter((element) => {return element != null});
    thread.facts = facts;
    let $q = $('#thread-facts');
    let data = thread.facts;
    for(let i = data.length - 1; i >= 0; i--) {
      let current = data[i];
      prepend_new_li($q, i, current.status, current.text);
    }
  }

  if(thread.questions) {
    let questions = thread.questions.filter((element) => {return element != null});
    thread.questions= questions;
    let $q = $('#thread-questions');
    let data = thread.questions;
    for(let i = data.length - 1; i >= 0; i--) {
      let current = data[i];
      prepend_new_li($q, i, current.status, current.text);
    }
  }
}

function clear_thread_contents() {
  let text_ids = [
    '#thread-title',
    '#thread-description'
  ];

  for(let i = 0; i < text_ids.length; ++i) {
    $(text_ids[i]).find('span').html('untitled');
  }

  $('.thread-list-item').remove();
  $('.character-list-item').remove();
  $('.scene-list-item').remove();
}


function scene_set_active_user(user) {

  this.user_active = user;

  this.on_user_active_change.forEach ( (func) => { func(this) } );

  console.log(this);

}

class Scene {

  #name;

  constructor() {

    this.id = crypto.randomUUID();
    this.#name= 'untitled';

    this.user_active = null;
    this.characters = []; // [{id: 'gm-001', name: 'GM', type: 1}];
    this.npcs = [];
    this.log_entries = [];

    this.log = scene_log_add;

    this.on_name_change = [];
    this.on_user_active_change = [];
    this.on_log_add = [];
    this.on_npc_add = [];
    this.on_characters_add = [];

    this.user_active = this.characters[0];
  }

  get name() {
    return this.#name;
  }

  set name(_name) {
    this.#name = _name;

    this.on_name_change.forEach( (f) => f(this) );

  }

  set_active_user(user_id) {
    console.log('User ID: ' + user_id);

    let user = this.characters.find( (items) => {return items.id == user_id} );

    if(user == null) {
      throw new Error( "user_id with id '" + user_id + "' not found");
    }

    this.user_active = user;

    this.on_user_active_change.forEach((func) => {func(this)});
  }

  add_character(user) {
    this.characters.push(user);
    this.on_characters_add.forEach( (func) => {func(user) } );
  }
  
  add_npc(npc) {
    this.npcs.push(npc);
    this.on_npc_add.forEach( (func) => {func(npc) } );
  }
}

function scene_log_add(text, log_type) {

  let scene = this;

  scene.log_entries.push(text);

  this.on_log_add.forEach( (f) => f(scene, log_type) );
  // for(let i = 0; i < scene.on_log_add.length; ++i) {
  //   scene.on_log_add[i](scene, log_type);
  // }
}

function scene_oracle_query_click() {
  oracle.query();

  $('#thread-scene-input input[type=text]').focus();
}

function thread_end_scene() {
  $('#thread-tabs').removeClass('hidden');
  $('#thread-details-contents').removeClass('hidden');
  $('#thread-footer-buttons').removeClass('hidden');

  $('#thread-scene').addClass('hidden');
  $('#thread-footer-scene-buttons').addClass('hidden');

  adventure.active_thread.active_scene = null;
}


function scene_observer_thread_scene_log(scene, log_type) {
  
  let latest_entry = scene.log_entries[scene.log_entries.length-1];

  let oracle_result_string = (result) => {

    let text = [
      '<span>', result.text, '</span> ',
      '<span>', result.unexpected?.text || '', '</span> ',
    ].join('');

    let images = null;
    let icons = data_icons_actions;
    if(result.images != null) {
      images = [];
      for(let i = 0; i < result.images.length; ++i) {
        images.push(
          [ '<span class="oracle-result-image">',
            '<img src="',
            icons[result.images[i]],
            '"/>',
            '</span>'
          ].join('')
        );
      }
    }

    let contents = [ text, (images?.join('') || '') ].join('');
    return contents;
  }

  let is_object = (typeof latest_entry === 'object');

  if(is_object)
    latest_entry = oracle_result_string(latest_entry);

  let $l = $('#thread-scene-log');

  let user = scene.user_active;

  let line_css = 'thread-log-system';

  switch(Number(log_type || -1)) {
    case 1:
     line_css = 'thread-log-gm';
      break;
    case 2:
     line_css = 'thread-log-player';
      break;
  }

  let div =  [
    '<div class="scene-log-item ',
    line_css,
    '">',
    log_type === 3 ? '' : [scene.user_active.name, ': '].join(''),
    ' ',
    latest_entry,
    '</div>'
  ].join('');

  $l.append(div);

  $l[0].scrollTop = $l[0].scrollHeight;
}

function scene_observer_on_name_change(scene) {
    console.log(adventure.active_thread.scenes[0]);
    console.log(adventure.active_thread.active_scene);
    console.log(scene);

  if(adventure.active_thread.active_scene.id == scene.id) {
    $('#thread-scene-title').find('span').html(scene.name);
  }

  $('#thread-scene-list').find('#' + scene.id).html(scene.name);

}

function scene_observer_thread_scene_user_change(scene) {

  let is_gm = scene.user_active.id.toUpperCase() == 'GM-001';

  let $query = $('#gm-buttons');
  if(is_gm) {
    $query.removeClass('hidden');
    $('#player-buttons').addClass('hidden');
  }
  else {
    $query.addClass('hidden');
    $('#player-buttons').removeClass('hidden');
  }

  let $input = $('#thread-scene-input input[type=text]');
  $input.focus();

}

function scene_oracle_observer_query_result(oracle, result) {

  if($('#thread-scene').hasClass('hidden')) return;

    let text = [
      '<span>', result.text, '</span> ',
      '<span>', result.unexpected?.text || '', '</span> ',
    ].join('');

    let images = null;
    let icons = data_icons_actions;
    if(result.images != null) {
      images = [];
      for(let i = 0; i < result.images.length; ++i) {
        images.push(
          [ '<span class="oracle-result-image">',
            '<img src="',
            icons[result.images[i]],
            '"/>',
            '</span>'
          ].join('')
        );
      }
    }

  // console.log('scene oracle result: ' + text);

  let scene = adventure.active_thread.active_scene; //scenes[0];
  let contents = [ text, (images?.join('') || '') ].join('');

  scene.log(result, 3);
}

function thread_scene_input_tab_click(sender) {
  // doing something to get current scene

  let $s = $(sender);
  let $p = $s.parent();
  $p.find('.selected').removeClass('selected');
  $s.addClass('selected');


  

  let scene = adventure.active_thread.active_scene; //scenes[0];
  scene.set_active_user($(sender).attr('userid'));
}

function thread_scene_input_keypress(sender, event) {
  if(event.keyCode === 13){
    // DO something to get current scene
    let s = adventure.active_thread.active_scene; // scenes[0];
    let v = sender.value.trim();


    if(v.length > 0) {
      let $selected =$('#thread-scene-input')
                  .find('.char-tab.selected');
      let log_type = $selected.attr('log_type');
                
      s.log(v, log_type);
    }

    sender.value = '';
  }
}


let oracle;
let adventure = null;
let threads = [];
let scenes = [];


function thread_init(thread) {
  thread.on_title_change.push(thread_observer_on_title_change);
  thread.on_description_change.push(thread_observer_on_description_change);
  thread.on_list_item_add.push(thread_observer_on_question_or_fact_add);
  thread.on_list_item_toggle.push(thread_observer_on_list_item_toggle);
  thread.on_active_scene_change.push(thread_observer_on_active_scene_change);

  thread.on_scene_add.push(thread_observer_on_scene_add);
}

function scene_init(scene) {
  scene.on_log_add.push(scene_observer_thread_scene_log);
  scene.on_user_active_change.push(scene_observer_thread_scene_user_change);
  scene.on_name_change.push(scene_observer_on_name_change);

  scene.on_npc_add.push( (user) => {console.log('User Add: ' + user)});

  // scene.add_character({id: '001', name: 'Sullivan', type: 2});
}

function on_load() {


  adventure = new Adventure();
  adventure.on_thread_add.push(adventure_observer_on_thread_add);
  adventure.on_thread_active.push(adventure_observer_on_thread_active);

  let t = adventure.create_thread();
  thread_init(t);
  

  //let t = new Thread();
  //t.on_scene_add.push(thread_observer_on_scene_add);
  //t.create_scene();
  
  

  // let s = scene_new();
  // let s = new Scene();

  // s.on_log_add.push(scene_observer_thread_scene_log);
  // s.on_user_active_change.push(scene_observer_thread_scene_user_change);
  // s.on_npc_add.push( (user) => {console.log('User Add: ' + user)});

  // s.add_character({id: '001', name: 'Sullivan', type: 2});

  // scenes.push(s);


  oracle = new Oracle();
  oracle.add_on_set_surge_observer( oracle_observer_set_surge );
  // oracle.add_on_set_surge_observer((e) => {} );
  // oracle.add_on_query_result_observer( (r) => {console.log(r)} );
  oracle.add_on_query_result_observer( oracle_observer_query_result );
  oracle.add_on_query_result_observer( scene_oracle_observer_query_result );
}

on_load();


    </script>

</html>
