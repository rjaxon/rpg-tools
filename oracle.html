<!DOCTYPE html>
<html lang="en">
    <head>
        <title>
            RJ's RPG Tools - Oracle
        </title>

        <link rel="icon" href="img/icons/ffffff/000000/1x1/delapouite/dice-twenty-faces-twenty.svg">

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

        <link href="css/dice.css" rel="stylesheet">

        <script src="scripts/util.js"></script>
        <script src="scripts/dice.js"></script>
        <script src="scripts/data.js"></script>
        <script src="scripts/data/icons.js"></script>
        <script src="scripts/data/oracle.js"></script>

        <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.6.2.min.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">

    </head>
<style>

    ul {
      margin-bottom: 0px;
    }

    textarea {
        resize: none;
        width: 100%;
        height: 100%;
        border: 0px;
    }

    textarea:hover {
        border: none; /* Removes the border */
        outline: none; /* Removes the outline */
    }

    .hidden {
        display: none;
    }

    .label {
      font-weight: bold;
    }

    .pointer {
      cursor: pointer;
    }

    .red {
      color: red;
    }

    .bold {
      font-weight: bold;
    }

    .crossout {
      text-decoration: line-through;
    }

    .max-width {
      width: 100%;
    }

    .pad-10px {
      padding: 10px;
    }

    .align-right {
      text-align: right;
    }

    .thread-tab {
      margin-right: 5px;
    }

    .button-item {
      border-radius: 5px;
      border-bottom-left-radius: unset;
      border-bottom-right-radius: unset;
      border-bottom-color: white;
    }

    .oracle-scene-stage {
    }

    button.selected {
      background: white;
      border: 2px solid black;
      border-bottom-color: white;
      position: relative;
      top: 2px;
    }

    #oracle-container {
      padding: 1em;;
    }
    
    #oracle {
    }

    #oracle-result {
      border-radius: 5px;
      border-top-left-radius: unset;
      padding: 2em;
      font-weight: bold;
      font-size: 2em;
      text-align: center;
      border-left: 2px solid black;
      border-right: 2px solid black;
      border-top: 2px solid black;
      border-bottom-left-radius: unset;
      border-bottom-right-radius: unset;
    }

    #oracle-result-contents-hint {
      border-left: 2px solid black;
      border-right: 2px solid black;
      border-bottom: 2px solid black;
      border-radius: 5px;
      border-top-left-radius: unset;
      border-top-right-radius: unset;
      padding-left: 1em;
      padding-right: 1em;
      padding-bottom: 1em;
      text-align: center;
    }

    #oracle-result-contents {
      cursor: pointer;
    }

    .oracle-result-image {
      padding: 5px;
    }

    .oracle-scene-stage-item {
      border: 1px solid black;
    }

/*********************************/


  #thread-container {
    padding: 1em;
  }

  #thread-details {
    border-top: 2px solid black;
    border-left: 2px solid black;
    border-right: 2px solid black;
    border-radius: 5px;
    border-top-left-radius: unset;
    border-bottom-left-radius: unset;
    border-bottom-right-radius: unset;
  }

  #thread-details-contents {
    padding: 10px;
  }

  #thread-details-contents-input {
    height: 300px;
  }

  #threads-footer {
    height: 2.5em;
    text-align: right;
    padding-right: 10px;
    border-bottom: 2px solid black;
    border-left: 2px solid black;
    border-right: 2px solid black;

    border-radius: 5px;
    border-top-left-radius: unset;
    border-top-right-radius: unset;
  }

  #thread-scene {
  }

  #thread-scene-log {
    height: 500px;
    overflow-y: scroll;
  }

  .thread-log-system {
    color: red;
  }
/
  .thread-log-gm {
    color: green;
    padding-top: 2px;
    padding-bottom: 2px;
    padding-left: 5px;
  }

  .thread-log-player {
    color: blue;
    text-align: right;
    background: #eee;
    border-radius: 5px;
    padding-top: 2px;
    padding-bottom: 2px;
    padding-right: 5px;
  }


</style>

<body>

  <div id="oracle-container">
    <div id="oracle">
       <div id="oracle-surge" class="hidden">0</div>
        <div class="row">
            <div class="col-12">
              <div class="w3-bar w3-black">
                <button type="oracle" class="w3-bar-item w3-button button-item oracle-scene-stage selected" value="1" onclick="tab_click(this);">To Knowledge</button>
                <button type="oracle" class="w3-bar-item w3-button button-item oracle-scene-stage" value="2" onclick="tab_click(this);">To Conflict</button>
                <button type="oracle" class="w3-bar-item w3-button button-item oracle-scene-stage" value="3" onclick="tab_click(this);">To Endings</button>
              </div>
            </div>
            <div class="col-sm">
                <div id="oracle-result" value="1" surge="0">
                  <div id="oracle-result-contents" onclick="oracle_result_contents_click(this);">
                    Click here to query the loom of fate 
                  </div>
                </div>
            </div>
            <div class="col-12">
                  <div id="oracle-result-contents-hint"> </div>
            </div>
        </div>
    </div>
  </div>

  <div id="thread-container">
    <div id="threads">
      <div class="row">
        <div class="col-12 ">
            <!--button id="a-guid-001" type="threads" class="w3-bar-item w3-button button-item oracle-scene-stage selected" onclick="tab_click(this);">Thread 1</button>
            <button id="a-guid-001" type="threads" class="w3-bar-item w3-button button-item oracle-scene-stage" onclick="tab_click(this);">Thread 2</button>
            <button id="a-guid-001" type="threads" class="w3-bar-item w3-button button-item oracle-scene-stage" onclick="tab_click(this);">Thread 3</button>
            <button id="a-guid-001" type="threads" class="w3-bar-item w3-button button-item oracle-scene-stage" onclick="tab_click(this);">Thread 4</button-->
            <button  class="w3-bar-item w3-button button-item oracle-scene-stage" onclick="new_thread_click(this);">Add Thread</button>
        </div>

        <div class="col-sm">
            <div id="thread-details">
              <div id="thread-details-contents" class="">
                <div class="row">
                  <div class="col-12 label"><span id="thread-title" field="title" class="pointer editable" onclick="thread_item_click(this);")>Thread 1 Long Title</span></div>
                  <div class="col-12 label">Description</div>
                  <div class="col-12">
                    <span id="thread-description" field="description" class="pointer editable"  onclick="thread_item_click(this);")>
                    We were hired to find the victim and the kidnapper.
                    </span>
                  </div>
                  <div class="col-12 label">Facts</div>
                  <div class="col-12">
                      <ul id="thread-facts" field="facts">
                        <li class="thread-list-item"><span class="pointer" onclick="thread_list_item_click(this);">The mother was not around during the incident</span></li>
                        <li class="thread-list-item"><span class="pointer" onclick="thread_list_item_click(this);">The victim was trying to meet someone</span></li>
                        <li class="thread-list-item"><span class="pointer" onclick="thread_list_item_click(this);">The victom is male</span></li>
                        <li><span command="add-fact" class="pointer" onclick="thread_list_item_add(this);">Add Fact</span></li>
                      </ul>
                  </div>
                  <div class="col-12 label">Questions / Rumors</div>
                  <div class="col-12">
                      <ul id="thread-questions" field="questions">
                        <li class="thread-list-item" index="0"><span class="pointer" onclick="thread_list_item_click(this);">Where was the mother?</span></li>
                        <li class="thread-list-item" index="1"><span class="pointer" onclick="thread_list_item_click(this);">What is the victim's name?</span></li>
                        <li class="thread-list-item" index="2"><span class="pointer" onclick="thread_list_item_click(this);">Who was the victim trying to meet?</span></li>
                        <li><span command="add-question" class="pointer" onclick="thread_list_item_add(this);">Add Question</span></li>
                      </ul>
                  </div>

                  <div class="col-12 label">Notable Characters</div>
                  <div class="col-sm character-list-item">Character Name 1</div>
                  <div class="col-sm character-list-item">Character Name 2</div>
                  <div class="col-sm character-list-item">Character Name 3</div>
                  <div class="col-sm character-list-item">Character Name 4</div>
                  <div class="col-sm">Add Existing NPC</div>

                  <div class="col-12 label">Scenes</div>
                  <div class="col-sm scene-list-item">Scene 1</div>
                  <div class="col-sm scene-list-item">Scene 2</div>
                  <div class="col-sm scene-list-item">Scene 3</div>
                  <div class="col-sm scene-list-item">Scene 4</div>
                  <div class="col-sm scene-list-item">Scene 5</div>
                  <div class="col-sm">Add Scene</div>
                </div>
              </div>
              <div id="thread-scene" >
                <div id="thread-scene-log" class="col-12">
                  <div class="thread-log-gm">GM: gm text</div>
                  <div class="thread-log-player">Sullivan: character text text textt text</div>
                  <div class="thread-log-gm">GM: gm text</div>
                  <div class="thread-log-gm">GM: gm text</div>
                  <div class="thread-log-gm">GM: gm text</div>
                  <div class="thread-log-player">Sullivan: character text text textt text</div>
                  <div class="thread-log-player">Sullivan: character text text textt text</div>
                  <div class="thread-log-player">Sullivan: character text text textt text</div>
                  <div class="thread-log-player">Sullivan: character text text textt text</div>
                  <div class="thread-log-gm">GM: gm text</div>
                  <div class="thread-log-player">Sullivan: character text text textt text</div>
                  <div class="thread-log-gm">GM: gm text</div>
                  <div class="thread-log-player">Sullivan: character text text textt text</div>
                  <div class="thread-log-gm">GM: gm text</div>
                  <div class="thread-log-player">Sullivan: character text text textt text</div>
                  <div class="thread-log-gm">GM: gm text</div>
                  <div class="thread-log-player">Sullivan: character text text textt text</div>
                  <div class="thread-log-gm">GM: gm text</div>
                  <div class="thread-log-player">Sullivan: character text text textt text</div>
                  <div class="thread-log-gm">GM: gm text</div>
                  <div class="thread-log-player">Sullivan: character text text textt text</div>
                  <div class="thread-log-gm">GM: gm text</div>
                  <div class="thread-log-player">Sullivan: character text text textt text</div>
                  <div class="thread-log-gm">GM: gm text</div>
                  <div class="thread-log-player">Sullivan: character text text textt text</div>
                  <div class="thread-log-gm">GM: gm text</div>
                  <div class="thread-log-player">Sullivan: character text text textt text</div>
                  <div class="thread-log-gm">GM: gm text</div>
                  <div class="thread-log-player">Sullivan: character text text textt text</div>
                  <div class="thread-log-gm">GM: gm text</div>
                  <div class="thread-log-player">Sullivan: character text text textt text</div>
                  <div class="thread-log-gm">GM: gm text</div>
                  <div class="thread-log-player">Sullivan: character text text textt text</div>
                </div>
                <div id="thread-scene-input" class="col-12 pad-10px" style="border-top: 2px solid black;">
                  <div class="row">
                    <div class="col-6">
                      <button type="scene-button" userid="gm" class="w3-bar-item w3-button button-item selected" value="1" onclick="thread_scene_input_tab_click(this);">GM</button>
                      <button type="scene-button" userid="a-char-guid" class="w3-bar-item w3-button button-item " value="1" onclick="thread_scene_input_tab_click(this);">Sullivan</button>
                    </div>
                    <div class="col-6 align-right">
                      <button id="query-oracle" type="query-oracle" class="" value="1" onclick="">Query Oracle</button>
                    </div>
                    <div class="col-12">
                      <input type="text" class="max-width" onkeypress="thread_scene_input_keypress(this, event)" />
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="scene">
            </div>
        </div>

        <div class="col-12">
            <div id="threads-footer">
              <button>Edit</button>
              <button>Ok</button>
            </div>
        </div>

      </div>
    </div>
  </div>



</body>


    <script type="text/javascript">

class Oracle {

  constructor() {
    this.surge = 0;
    this.scene = 1;
    this.history = [];
    this.expectations = data_oracle_crge_unexpected;

    this.query = oracle_query;

    // ({ } )
    this.on_query_result = [];

    // (new_surge_value)
    this.on_set_surge = [];
  }
  
  // query(roll, roll_unexpected) {

  //   if(this.constructor.name != 'Oracle') { return; }

  //   let surge = this.surge;
  //   let scene = this.scene;

  //   let r = roll;
  //   if(r == null)
  //     r = dice(100);

  //   console.log(r);

  //   if(r <= 50) {
  //     r -= surge;
  //   }
  //   else {
  //     r += surge;
  //   }
  //   if(r < 1) r = 1;
  //   if(r > 100) r = 100;


  //   let result = null;
  //   let data = data_oracle_loom;

  //   let result_enum = {
  //     NO_AND_UNEXPECTED: 1,
  //     NO_BUT: 2,
  //     NO_AND: 3,
  //     NO: 4,
  //     YES: 5,
  //     YES_AND: 6,
  //     YES_BUT: 7,
  //     YES_AND_UNEXPECTED: 8,
  //   };

  //   let i = 1;
  //   for(i = 1; i <= data.length - 1; ++i) {
  //     let current = data[i];
  //     let range_check = current[0][scene];
  //     if(range_check[0] <= r && r <= range_check[1]) {
  //       result = current;
  //       break;
  //     }
  //   }

  //   let unexpected = null;
  //   if(i == result_enum.NO_AND_UNEXPECTED || i == result_enum.YES_AND_UNEXPECTED) {
  //     let unex_data = data_oracle_crge_unexpected;
  //     let d = roll_unexpected || dice(unex_data.length - 1);
  //     let unex = unex_data[d];
  //     unexpected = {
  //       result: d,
  //       text: unex[0],
  //       hint: unex[1]
  //     };
  //   }

  //   if(i == result_enum.YES || i == result_enum.NO) {
  //     surge += 2;
  //   }
  //   else {
  //     surge = 0;
  //   }

  //   let images = null;
  //   if(i == result_enum.YES_AND || i == result_enum.YES_BUT ||
  //      i == result_enum.NO_AND || i == result_enum.NO_BUT ) {

  //     images = [];
  //     let n = dice(5);
  //     let icons = data_icons_actions;
  //     for(let i = 0; i < n; ++i) {
  //       images.push(icons.length - 1);
  //     }
  //   }
  //   
  //   let roll_result = {
  //       roll: r,
  //       result: i,
  //       text: result[1],
  //       images: images,
  //       unexpected: unexpected
  //   };

  //   if(this.history.length > 3) {
  //     this.history.shift();
  //   }

  //   this.history.push(roll_result);

  //   this.on_query_result.forEach( (func) => { func(roll_result) } );
  // }


  // callback(oracle, roll_result)
  add_on_query_result_observer(callback) {
    this.on_query_result.push(callback);
  }

  add_on_set_surge_observer(callback) {
    this.on_set_surge.push(callback);
  }

  set_surge(s) {
    this.surge = s;
    this.on_set_surge.forEach( callback => { callback(this.surge); } );
  }
};


function oracle_query(_scene, _surge, roll, roll_unexpected) {

  if(this.constructor.name != 'Oracle') { return; }

  let surge = this.surge; 
  let scene = this.scene;

  let r = roll;
  if(r == null)
    r = dice(100);

  if(r <= 50) {
    r -= surge;
  }
  else {
    r += surge;
  }
  if(r < 1) r = 1;
  if(r > 100) r = 100;


  let result = null;
  let data = data_oracle_loom;
  let result_enum = {
    NO_AND_UNEXPECTED: 1,
    NO_BUT: 2,
    NO_AND: 3,
    NO: 4,
    YES: 5,
    YES_AND: 6,
    YES_BUT: 7,
    YES_AND_UNEXPECTED: 8,

  };
  let i = 1;
  for(i = 1; i <= data.length - 1; ++i) {
    let current = data[i];
    let range_check = current[0][scene];
    if(range_check[0] <= r && r <= range_check[1]) {
      result = current;
      break;
    }
  }

  let unexpected = null;
  if(i == result_enum.NO_AND_UNEXPECTED || i == result_enum.YES_AND_UNEXPECTED) {
    let unex_data = data_oracle_crge_unexpected;
    let d = roll_unexpected || dice(unex_data.length - 1);
    let unex = unex_data[d];
    unexpected = {
      result: d,
      text: unex[0],
      hint: unex[1]
    };
  }

  if(i == result_enum.YES || i == result_enum.NO) {
    surge += 2;
  }
  else {
    surge = 0;
  }

  this.set_surge(surge);

  let images = null;
  if(i == result_enum.YES_AND || i == result_enum.YES_BUT ||
     i == result_enum.NO_AND || i == result_enum.NO_BUT ) {

    images = [];
    let n = dice(5);
    let icons = data_icons_actions;
    for(let i = 0; i < n; ++i) {
      images.push(dice(icons.length - 1));
    }
  }

  let roll_result = {
      roll: r,
      result: i,
      text: result[1],
      images: images,
      unexpected: unexpected
  };
  
  if(this.history.length > 3) {
    this.history.shift();
  }
  this.history.push(roll_result);

  this.on_query_result.forEach( (func) => { func(this, roll_result) } );

  // return roll_result;
}


// function oracle_new() {
//   let oracle = { 
//     surge: 0,
//     scene_stage: 1,
//     history: [],
//     expectations: data_oracle_crge_unexpected,
// 
//     query: oracle_query,
//     
//     on_query_result: []
//   };
// 
//   return oracle;
// }

let oracle;


function thread_new(data) {

  let thread = {
    id: data?.id || crypto.randomUUID(),
    title: data?.title,
    description: data?.description,
    facts: data?.facts,
    questions: data?.questions,
    characters: data?.characters,
    scenes: data?.scenes
  };

  // thread.facts = [
  //   {status: 0, text: 'fact one'},
  //   {status: 1, text: 'fact two'},
  //   null, // {status: 1, text: 'fact thress'},
  //   {status: 0, text: 'fact 3 one'},
  //   {status: 1, text: 'fact 2 two'},
  //   {status: 1, text: 'fact 1 thress'}
  // ];

  // thread.questions = [
  //   {status: 0, text: 'one'},
  //   {status: 1, text: 'two'},
  //   {status: 1, text: 'thress'}
  // ];


  return thread;
}


function tab_click(sender) {

  let $s = $(sender);

  $s.parent().find('.selected').removeClass('selected');
  $s.addClass('selected');

  if($s.attr('type') == 'oracle') {
    $('#oracle-result').attr('value', sender.value);

    return;
  }

  if($s.attr('type') == 'threads') {
    on_thread_tab_click(sender);
  }
}

function new_thread_click(sender) {

  let $s = $(sender);
  let $p = $s.parent();

  $p.find('.selected').removeClass('selected');


  let new_thread = thread_new();
  threads.push(new_thread );

  $s.attr('onclick', 'tab_click(this);');
  $s.attr('type', 'threads');
  $s.attr('id', new_thread.id);
  $s.html('Untitled');
  $s.addClass('selected');

  $p.append([
    '<button class="w3-bar-item w3-button button-item thread-tab"',
    'onclick="new_thread_click(this);">',
    'Add Thread',
    '</button>'
  ].join(''));

  thread_load(new_thread);

}

function on_thread_tab_click(sender) {
  console.log('loading ' + sender.id);

  $('#thread-details').attr('thread-id', sender.id);
  
  let t = get_current_thread();
  thread_load(t)
  
}

function thread_item_click(sender) {
  console.log('editing ' + sender.id);
  let $s = $(sender);
  let $p = $s.parent();
  let val = $s.html().trim();

  $s.addClass('hidden');

  let input = [
    '<input type="text" value="', val, '" ',
    'class="max-width"',
    'onblur="thread_item_edit_blur(this);"',
    'onkeypress="thread_item_edit_keypress(this, event);"',
    '/>'
  ];

  $p.append(input.join(''));
  let $in = $p.find('input');
  $in.focus();
  $in[0].setSelectionRange(val.length, val.length);
}

function thread_item_edit_blur(sender) {
  on_thread_edit_finish(sender);
}

function thread_item_edit_keypress(sender, event) {
  if(event.keyCode === 13){
    on_thread_edit_finish(sender);
  }
}

function on_thread_edit_finish(sender) {
  console.log('edit item lost focus');
  let $s = $(sender);
  let $p = $s.parent();

  let $v = $p.find('span');
  let text = $s.val().trim();
  $v.html( text.length == 0 ? 'untitled' : text );
  if($v.hasClass('hidden')) {
    $v.removeClass('hidden');
    $s.remove();
  }

  // var id = $('#thread-details').attr('thread-id');
  // let t = threads.find( (item) => {return item.id == id} );
  let t = get_current_thread();
  if(t) {
    t[$v.attr('field')] = text;
  }
}

function get_current_thread() {

  var id = $('#thread-details').attr('thread-id');
  let t = threads.find( (item) => {return item.id == id} );

  return t;
}

function thread_list_item_click(sender) {
  console.log('list item click');

  let $s = $(sender);
  let $p = $s.parent();
  let state = $s.attr('state');
  let index = Number($p.attr('index'));
  let thread = get_current_thread();
  let field = $p.parent().attr('field');
  
  if(state == 'crossed') {
    $s.removeClass('crossout');
    $s.attr('state', '');
    let $d = $p.find('.delete-item');
    $d.remove();
    thread[field][index].status = 0;
  }
  else {
    $s.addClass('crossout');
    $s.attr('state', 'crossed');
    let x = [ ' ',
      '<span class="delete-item pointer bold red" ',
      'onclick="thread_list_item_delete(this);"',
      '>X</span>'
    ];
    $p.append(x.join(''));
    thread[field][index].status = 1;
  }
}

function thread_list_item_delete(sender) {
  let $s = $(sender);
  let $p = $s.parent();

  // let $v = $p.find('span');

  let index = Number($p.attr('index')); // Number($v.attr('index'));

  let $pp = $p.parent();

  let t = get_current_thread();
  let field = $pp.attr('field');
  t[field][index] = null;


  $p.remove();
}

function thread_list_item_add(sender) {
  let $s = $(sender);
  let $p = $s.parent();
  let text = $s.html();

  $s.remove();

  let input = [
    '<input type="text" ',
    'class="max-width"',
    'onblur="thread_list_item_add_blur(this);"',
    'onkeypress="thread_list_item_add_keypress(this, event);"',
    '/>'
  ].join('');

  $p.append(input);

  let add_item = ['<li>',
    '<span command="add-question" ',
    'class="pointer" ',
    'onclick="thread_list_item_add(this);">',
    text,
    '</span></li>'].join('');

  $p.parent().append(add_item);

  let $in = $p.find('input');
  $in.focus();
  $in[0].setSelectionRange(0, 0);
}

function thread_list_item_add_blur(sender) {
  on_thread_list_item_add_finish(sender);
}

function thread_list_item_add_keypress(sender, event) {
  if(event.keyCode === 13){
    on_thread_list_item_add_finish(sender);
  }
}

function on_thread_list_item_add_finish(sender) {
  let $s = $(sender);
  let $p = $s.parent();
  
  let text = $s.val().trim();

  if(text.trim().length == 0) {
    $p.remove();
    return;
  }
  
  if($p.find('span').length == 0) {
    let span = [ '<span ',
      'class="pointer" ',
      'onclick="thread_list_item_click(this);">',
      text,
      '</span></li>'].join('');

    if($p.hasClass('thread-list-item') == false ) {
      $p.addClass('thread-list-item');
    }
    $p.append(span);

    $s.remove();
    
    $pp = $p.parent();
    let field = $pp.attr('field');
    let t = get_current_thread();
    if(t) {
      if(t[field] == null) {
        t[field] = [];
      }

      let index = t[field].length;
      t[field].push({status: 0, text: text});
      $p.find('span').attr('index', index); 
    }

  }
}


function oracle_observer_set_surge(value) {
  console.log('surge: ' + value);
}

function oracle_observer_query_result(oracle, result) {

  // console.log(result);

  // console.log('query result observer');


  let action = function() {
    let scene = oracle.scene; // $('#oracle-result').attr('value');
    let surge = oracle.surge; // $('#oracle-result').attr('surge');

    // let result = oracle_query(Number(scene), Number(surge));
    let text = [
      '<span>', result.text, '</span> ',
      '<span>', result.unexpected?.text || '', '</span> ',
    ];

    let images = null;
    let icons = data_icons_actions;
    if(result.images != null) {
      images = [];
      for(let i = 0; i < result.images.length; ++i) {
        images.push(
          [ '<span class="oracle-result-image">',
            '<img width="45" height="45" src="',
            icons[result.images[i]],
            '"/>',
            '</span>'
          ].join('')
        );
      }
    }

    // $(sender).html(text.join('') + (images?.join('') || ''));
    _('oracle-result-contents').innerHTML = text.join('') + (images?.join('') || '');
    $('#oracle-result-contents-hint').html(result.unexpected?.hint || '');
  };


  _('oracle-result-contents').innerHTML = '<img src="img/spinner.svg" width="45" height="45" />';

  // sender.innerHTML = '<img src="img/spinner.svg" width="45" height="45" />';

  setTimeout(function() {
    action();
  }, dice(750) + 250);

}

function oracle_result_contents_click(sender) {
  
  oracle.query();

  // let action = function() {
  //   let scene = $('#oracle-result').attr('value');
  //   let surge = $('#oracle-result').attr('surge');

  //   let result = oracle_query(Number(scene), Number(surge));
  //   let text = [
  //     '<span>', result.text, '</span> ',
  //     '<span>', result.unexpected?.text || '', '</span> ',
  //   ];

  //   let images = null;
  //   if(result.images != null) {
  //     images = [];
  //     for(let i = 0; i < result.images.length; ++i) {
  //       images.push(
  //         [ '<span class="oracle-result-image">',
  //           '<img width="45" height="45" src="',
  //           result.images[i],
  //           '"/>',
  //           '</span>'
  //         ].join('')
  //       );
  //     }
  //   }

  //   $(sender).html(text.join('') + (images?.join('') || ''));
  //   $('#oracle-result-contents-hint').html(result.unexpected?.hint || '');
  // };


  // sender.innerHTML = '<img src="img/spinner.svg" width="45" height="45" />';

  // setTimeout(function() {
  //   action();
  // }, dice(750) + 250);

}

function plot_hook(r1, r2, r3, r4, r5, r6) {

  let data = data_plot_hooks;

  let rolls = [ r1, r2, r3, r4, r5, r6 ];

  let init = function(v) {
    if(v == null) {
      return dice(data.length - 1);
    }
    return v;
  }

  for(let i = 0; i < rolls.length; ++i) {
    rolls[i] = init(rolls[i]);
  }
  
  let results = [];
  for(i = 0; i < rolls.length; ++i) {
    let r = data_lookup_single(data, rolls[i]);
    results.push([
      '<span>', r.result[i], '</span> '
    ].join(''));
  }

  return results.join('');
}


function thread_load(thread) {

  if(thread == null)
    return;

  clear_thread_contents();

  $('#thread-details').attr('thread-id', thread.id);
  $('#thread-title').html(thread.title);
  $('#thread-description').html(thread.description);

  let prepend_new_li = function($element, i, crossed, text) {
    
    let x = '';
    if(crossed) {
      x = [ ' ',
        '<span class="delete-item pointer bold red" ',
        'onclick="thread_list_item_delete(this);">',
        'X',
        '</span>'
      ].join('');
    }

    let li = [ 
      '<li class="thread-list-item" index="',
      i,
      '"><span class="pointer ',
      crossed ? 'crossout' : '',
      '"' ,
      'onclick="thread_list_item_click(this);" ', 
      crossed ? 'state="crossed"' : '',
      '>',
      text,
      '</span>',
      x,
      '</li>'].join('');

    $element.prepend(li);
  }

  if(thread.facts) {
    let facts = thread.facts.filter((element) => {return element != null});
    thread.facts = facts;
    let $q = $('#thread-facts');
    let data = thread.facts;
    for(let i = data.length - 1; i >= 0; i--) {
      let current = data[i];
      prepend_new_li($q, i, current.status, current.text);
    }
  }

  if(thread.questions) {
    let questions = thread.questions.filter((element) => {return element != null});
    thread.questions= questions;
    let $q = $('#thread-questions');
    let data = thread.questions;
    for(let i = data.length - 1; i >= 0; i--) {
      let current = data[i];
      prepend_new_li($q, i, current.status, current.text);
    }
  }
}

function clear_thread_contents() {
  let text_ids = [
    '#thread-title',
    '#thread-description'
  ];

  for(i = 0; i < text_ids.length; ++i) {
    $(text_ids[i]).html('untitled');
  }

  $('.thread-list-item').remove();
  $('.character-list-item').remove();
  $('.scene-list-item').remove();
}

let threads = [];

let scenes = [];

function scene_set_active_user(user) {

  this.user_active = user;

  this.on_user_active_change.forEach ( (func) => { func(this) } );

  console.log(this);

}

function scene_new() {
  let scene = {
    id: '001',

    user_active: 'gm',
    users: [],
    log: [],

    set_active_user: scene_set_active_user, // (user)
    log_add: scene_log_add, // (text)

    on_user_active_change: [],
    on_log_add: [],
    on_load: []
  };

  scene.users.push('GM')

  // a character object
  scene.users.push({id: 'a-guid', name: 'Sullivan'});

  scene.user_active = scene.users[0];

  return scene;
};

function scene_log_add(text) {

  let scene = this;

  scene.log.push(text);

  for(let i = 0; i < scene.on_log_add.length; ++i) {
    scene.on_log_add[i](scene);
  }
}

function test_scene_observer(scene) {

  console.log(scene.log[scene.log.length-1]);

}

function scene_observer_thread_scene_log(scene) {
  
  let latest_entry = scene.log[scene.log.length-1];

  let $l = $('#thread-scene-log');

  let user = scene.user_active;
  let is_gm = user.toUpperCase() == 'GM';
  let is_system = false;
  let line_css = 'thread-log-system';

  if(is_gm) {
    line_css = 'thread-log-gm';
  }
  else if(is_system) {
    line_css = 'thread-log-system';
  }
  else {
    line_css = 'thread-log-player';
  }

  let div =  [
    '<div class="',
    line_css,
    '">',
    scene.user_active, ': ',
    ' ',
    latest_entry,
    '</div>'
  ].join('');

  $l.append(div);

  $l[0].scrollTop = $l[0].scrollHeight;
}

function scene_observer_thread_scene_user_change(scene) {
  console.log('user switch: ' + scene.user_active);

  let is_gm = scene.user_active.toUpperCase() == 'GM';

  let $query = $('#query-oracle');
  if(is_gm) {
    $query.removeClass('hidden');
  }
  else {
    $query.addClass('hidden');
  }


}

function thread_scene_input_tab_click(sender) {
  // doing something to get current scene

  let $s = $(sender);
  let $p = $s.parent();
  $p.find('.selected').removeClass('selected');
  $s.addClass('selected');

  let scene = scenes[0];

  scene.set_active_user($(sender).attr('userid'));

}

function thread_scene_input_keypress(sender, event) {
  if(event.keyCode === 13){
    // DO something to get current scene
    let s = scenes[0];
    let v = sender.value.trim();

    if(v.length > 0) {
      s.log_add(v);
    }

    sender.value = '';
  }
}

function on_load() {

  let s = scene_new();
  s.on_log_add.push(test_scene_observer);
  s.on_log_add.push(scene_observer_thread_scene_log);
  s.on_user_active_change.push(scene_observer_thread_scene_user_change);

  scenes.push(s);


  oracle = new Oracle();
  oracle.add_on_set_surge_observer( oracle_observer_set_surge );
  // oracle.add_on_set_surge_observer((e) => {} );
  // oracle.add_on_query_result_observer( (r) => {console.log(r)} );
  oracle.add_on_query_result_observer( oracle_observer_query_result );
}

on_load();


    </script>

</html>
