<!DOCTYPE html>
<html lang="en">
  <head>
    <title>
        RJ's RPG Tools - Characters
    </title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.6.2.min.js"></script>
    
    
    <link rel="icon" href="img/icons/ffffff/000000/1x1/delapouite/dice-twenty-faces-twenty.svg">
    <link href="css/dice.css" rel="stylesheet">
    
    <script src="scripts/dice.js"></script>
    <script src="scripts/data/icons.js"></script>
    <script src="scripts/data/npc.js"></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">

  </head>

<style>
  div {
    border: 3px solid black;
    width: 50%;
  }

  .label {
    font-weight: bold;
  }
</style>

    <body>
      <panel>
        <div class="label">Character:</div>
        <div>
          <span class="label">Name:</span>
          <span id="name"></span>
        </div>
        <div>
          <span class="label">Core</span>
          <span id="core"></span>
        </div>
        <div>
            <span class="label">Power Level:</span>
            <span id="power_level"></span>
        </div>
        <div>
            <span class="label">Motivation</span>
            <span id="motivation"</span>
        </div>
        <div>
          <span class="label">Combined Terms</span>
          <span> </span>
        </div>
        
        <div style="margin-top: 2em;" class="label">Interactions</div>
        <div>
          <span class="label">Relationship to: </span>
          <span id="relationship"></span>
        </div>
        <div>
          <span class="label">Conversation Mood</span>
          <span id="mood"></span>
        </div>
        <div class="label">NPC Importance</div>
        <div>
          <span class="label">demeanor</span>
          <span id="demeanor"></span>
        </div>
        <div>
          <span class="label">bearing</span>
          <span id="bearing"></span>
        </div>
        <div>
          <span class="label">NPC Focus</span> 
          <span id="focus"></span> 
        </div>
      </panel>
    </body>


<script type="text/javascript">


function data_lookup_single(data, roll) {

  let d = roll;
  if(d == null) {
    d = dice(data.length - 1);
  }

  return {roll: d, result: data[d] };
}

function data_lookup_range(data, roll) {

  let result = null;
  for(let i = 1; i <= data.length - 1; ++i) {
    let current = data[i];
    if(current[0] <= roll && roll <= current[1]) {
      // result = current[2];
      result = current;
      break;
    }
  }

  return {result: result, roll: roll};
}

function entity_new(params) {

  let entity = {
    id: null,
    name: {first: params?.first || dice(100), 
           last_a: { v: params?.last_a[0] || dice(100), 
            ab: params?.last_a[1] || dice(100), 
            ext: params?.last_a[2] || dice(100)},
           last_b: { v: params?.last_b[0] || dice(100), 
             ab: params?.last_b[1] || dice(100), 
             ext: params?.last_b[2] || dice(100) }},
    core: {modifier: params?.core[0] || dice(100), noun: params?.core[1] || dice(100)},
    power: params?.power || dice_n(3, 6).total,
    motivation: [], // {verb: null, noun: null}, initialization: see below
    relationship: params?.relationship || dice_n(3, 6).total,
    mood: params?.mood || dice(100),
    demeanor: params?.demeanor || dice(8),
    bearing: params?.bearing || dice(8),
    focus: params?.focus  || dice(100)

  };

  if(params && params.motivation) {
    for(let i = 0; i < params.motivation.length; ++i) {
      let current = params.motivation[i];
      entity.motivation.push(
        {
          verb: current[0] || dice(100),
          noun: current[1] || dice(100)
        });
    }
  }
  else {
    for(let i = 1; i <= 3; ++i) {
      entity.motivation.push(
        {
          verb: dice(100),
          noun: dice(100)
        });
    }
  }

  return entity;
}



function npc_demeanor(roll) {
  let r = data_lookup_single(data_npc_demeanor, roll);
  return r.result + ' (' + r.roll + ') ';
}

function npc_bearing(demeanor, roll) {

  let bearing = data_npc_bearing[demeanor];
  let r = data_lookup_single(bearing, roll);

  return r.result + ' (' + r.roll + ') ';

  // let v = dice(10);
  // let d = dice(8);

  // if(roll)
  //   v = roll;

  // if(demeanor)
  //   d = demeanor;

  // let bearing = {};
  // bearing.demeanor = data_npc_demeanor[d];
  // bearing.bearing = data_npc_bearing[d][v];
  // 
  // return bearing.demeanor + ' ' +
  //        bearing.bearing + ' (' + v + ', ' + d + ')';
}

function npc_focus(roll) {

  let r = data_lookup_range(data_npc_focus, roll);

  // let v = dice(100);
  // if(roll)
  //   v = roll;

  // let f = data_npc_focus;

  // let result = '-';

  // for(let i = 1; i < f.length; ++i) {
  //   let current = f[i];
  //   if(current[0] <= v && v <= current[1]) {
  //     result = current[2];
  //     break;
  //   }
  // }

  return "PC's " + r.result[2] + ' (' + r.roll + ')';
}


function npc_relationship(roll_3d6) {

  let d = roll_3d6;
  if(d == null)
    d = dice_n(3, 6);

  let r = data_lookup_range(data_npc_relationship, d);
  return r.result[2] + ' (' + r.roll + ')'; 
}

function npc_mood(relationship, roll) {

  let r = roll;
  if(roll == null)
    r = dice(100);

  let relate = 3;
  for(let i = 1; i < data_npc_relationship.length - 1; ++i) {
    let current = data_npc_relationship[i];
    if(current[0] <= relationship && relationship <= current[1]) {
      relate = i;
      break;
    }

  }

  let result = data_lookup_range(data_npc_mood[relate], r);
  
  // let m = data_npc_mood[r];

  // let result = '-';

  // for(let i = 1; i < m.length; ++i) {
  //   let current = m[i];
  //   if(current[0] <= v && v <= current[1]) {
  //     result = current[2];
  //     break;
  //   }
  // }

  return result.result[2] + ' (' + result.roll + ')';

}

function npc_name_first(roll) {

  let r = data_lookup_single(data_npc_names, roll);
  return r.result[0] + ' (' + r.roll + ')'; 
}

function npc_name_last(use_first, roll, ab, extended) {

  let is_a = false || use_first;
  let r = data_lookup_single(data_npc_names, roll);
  let d = r.roll;
  let result = r.result;
  let a = ab;
  let ext = extended;

  if(a == null)
    a = dice(2);

  let n = 0;
  if(is_a)  // first half of last name?
    n = result[ab == 1 ? 1 : 3];
  else
    n = result[ab == 1 ? 2 : 4];

  // ie: use the -er in slay(er)
  if(ext == null)
    ext = dice(2);

  if(ext == 1) {
    n = n.replace('(', '').replace(')', '');
  }
  else if(0 < n.indexOf('(')) {
    n = n.substring(0, n.indexOf('('));
  }

  return n + ' (' + d + ')';

}

// function npc_name_last_b(roll, ab) {
//   let d = roll;
//   if(d == null) {
//     d = dice(data_npc_names.length - 1);
//   }
// 
//   let a = ab;
//   if(a == null)
//     a = dice(2);
// 
//   let n = data_npc_names[d][ab == 1 ? 2 : 4];
//   if(dice(2) == 1) {
//     n = n.replace('(', '').replace(')', '');
//   }
//   else if(0 < n.indexOf('(')) {
//     n = n.substring(0, n.indexOf('('));
//   }
// 
//   return n + ' (' + d + ')';
// 
// }

function npc_name(entity) {
  // let length = data_npc_names.length - 1;
  // name.first = data_npc_names[dice(length) ][0];
  // name.last_a = data_npc_names[dice(length) ][dice(2) == 1 ? 1 : 3];
  // name.last_b = data_npc_names[dice(length) ][dice(2) == 1 ? 2 : 4];
 
  let name = npc_name_first(entity.name.first) + ' ' +
//             npc_name_last_a(entity.name.last_a.v, entity.name.last_a.ab) +
//             npc_name_last_b(entity.name.last_b.v, entity.name.last_b.ab);
             npc_name_last(true, entity.name.last_a.v, entity.name.last_a.ab, entity.name.last_a.ext) +
             npc_name_last(false, entity.name.last_b.v, entity.name.last_b.ab, entity.name.last_b.ext);

  return name;
}

function npc_core_modifier(roll) {
  let d = roll;
  if(d == null)
    d = dice(data_npc_modifiers.length - 1);

  return data_npc_modifiers[d] + ' (' + d + ')';
}

function npc_core_noun(roll) {
  let d = roll;
  if(d == null)
    d = dice(data_npc_nouns.length - 1);

  return data_npc_nouns[d] + ' (' + d + ')';
}

function npc_motivation_verb(roll) {
  let d = roll;
  if(d == null)
    d = dice(data_npc_motivation_verbs.length - 1);

  return data_npc_motivation_verbs[d] + ' (' + d + ')';
}

function npc_motivation_noun(roll) {
  let d = roll;
  if(d == null)
    d = dice(data_npc_motivation_nouns.length - 1);

  return data_npc_motivation_nouns[d] + ' (' + d + ')';
}

function npc_motivation() {
  let motivation = {};

  motivation.verb = npc_motivation_verb();
  motivation.noun = npc_motivation_noun();

  return motivation;
}

// function test() {
// 
//   for(let i = 0; i < 500; ++i) {
//     let d = dice_n(3, 6);
//     let r = data_npc_power_level[d.total];
//     console.log(i + ': '  + d.rolls.join(' + ') + ' = ' + d.total + ' - ' + r);
//     if(r == 'Much Stronger')
//       break;
//   }
// }


function npc_power_level(roll_3d6) {

  let d = roll_3d6;
  if(d == null)
    d = dice_n(3, 6);

  let r =  data_lookup_range(data_npc_power_level, d);
  return r.result[2] + ' (' + r.roll + ')';

}

function ui_entity_name(entity) {
  $('#name').html(npc_name(entity));
}


function ui_entity_power_level(entity) {
  $('#power_level').html(npc_power_level(entity.power));
}

function ui_entity_motivation(entity) {

  let motivation = [];
  for(let i = 0; i < entity.motivation.length; ++i) {
    let current = entity.motivation[i];
    motivation.push(npc_motivation_verb(current.verb) );
    motivation.push(' ');
    motivation.push(npc_motivation_noun(current.noun) );
    motivation.push('<br/>');
  }

  $('#motivation').html(motivation.join(''));

}

function ui_entity_core(entity) {
  let core = [];
  core.push(npc_core_modifier(entity.core.modifier));
  core.push(' ');
  core.push(npc_core_noun(entity.core.noun));
  $('#core').html(core.join(''));
}

function ui_entity_relationship(entity) {
  $('#relationship').html(npc_relationship(entity.relationship));
}

function ui_entity_mood(entity) {
  $('#mood').html(npc_mood(
    entity.relationship,
    entity.mood));
}

function ui_entity_demanor(entity) {
  $('#demeanor').html(npc_demeanor(entity.demeanor));
}

function ui_entity_bearing(entity) {
  $('#bearing').html(npc_bearing(entity.demeanor, entity.bearing));
}

function ui_entity_focus(entity) {
  $('#focus').html(npc_focus(entity.focus));
}

function ui_entity_display(entity) {
  ui_entity_name(entity);
  ui_entity_motivation(entity);
  ui_entity_power_level(entity);
  ui_entity_core(entity);
  ui_entity_relationship(entity);
  ui_entity_mood(entity);
  ui_entity_demanor(entity);
  ui_entity_bearing(entity);
  ui_entity_focus(entity);
}

function on_load() {

  let npc = entity_new(
    {
      first: 1,
      last_a: [ 1,1, 2],
      last_b: [33,2, 1],
      core: [12, 77],
      power: 14,
      motivation: [[5, 2], [8, 9], [20, 5]],
      relationship: 5,
      mood: 2,
      demeanor: 4,
      bearing: 5,
      focus:  32
    }
  );
  console.log(npc);

  ui_entity_display(npc);


  // let npc2 = new entity_new(); {
  //   ui_entity_display(npc);

  // }
  // ui_entity_display(npc2);

}

on_load();

</script>
</html>
