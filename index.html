<!DOCTYPE html>
<html lang="en">
    <head>
        <title>
            RJ's RPG Tools
        </title>

        <link rel="icon" href="img/icons/ffffff/000000/1x1/delapouite/dice-twenty-faces-twenty.svg">

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
        <link href="css/dice.css" rel="stylesheet">

        <script src="scripts/data/icons.js"></script>
        <script src="scripts/dice.js"></script>
        <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.6.2.min.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">

    </head>
<style>
 body {
     background: #ccc;
 }

 .hidden {
     display:none;
 }


 .ui-item {
    border: 5px solid black;
    height: 3.75em;
    width: 3.75em;
    text-align: center;
    vertical-align: middle;
    margin: 5px;
    padding-top: 1em;
    font-size: 3em;
    font-weight: bold;
    border-radius: 10px;
 }

 .no-pad {
   padding: 0;
 }

 .absolute {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    margin-left: auto;
    margin-right: auto;
    width: 100%;
 }
 .selected {
    background-color: yellow !important;
 }

 .red {
     background: red;
 }

 .gray {
     background: #aaa;
 }

 .gray-lt {
     background: #ccc;
 }

</style>
    <body>
    
        <div id="input" class="container">
            <div class="row">
                <div id="input-dice-type" onclick="input_click(this);" class="col-4"><div class="gray ui-item" style="width: 2.3em;">20</div></div>
                <div id="input-dice-roll"  onclick="input_click(this);" class="col-4"><div class="gray ui-item" style="width: 2.3em;">Roll</div></div>
                <div id="input-dice-count"  onclick="input_click(this);" class="col-4"><div class="gray ui-item" style="width: 2.3em;">4</div></div>
            </div>
        </div>

        <div id="panel-dicetype" class="gray-lt absolute hidden container">
          <div class="row">
            <div class="col-6"><div class="panel-dicetype-item gray ui-item">6</div></div>
            <div class="col-6"><div class="panel-dicetype-item gray ui-item">8</div></div>
          </div>
          <div class="row">
            <div class="col-6"><div class="panel-dicetype-item gray ui-item">10</div></div>
            <div class="col-6"><div class="panel-dicetype-item gray ui-item">12</div></div>
          </div>
          <div class="row">
            <div class="col-6"><div class="panel-dicetype-item gray selected ui-item">20</div></div>
            <div class="col-6"><div class="panel-dicetype-item gray ui-item">100</div></div>
          </div>
          <div class="row">
            <div class="col-6"><div class="panel-dicetype-item gray ui-item">RR</div></div>
            <div class="col-6"><div class="panel-dicetype-item gray ui-item">FF</div></div>
          </div>
        </div>

        <div id="panel-dicecount" class="gray-lt absolute hidden container">
          <div class="row">
            <div class="col-6"><div class="panel-dicecount-item gray ui-item">1</div></div>
            <div class="col-6"><div class="panel-dicecount-item gray ui-item">2</div></div>
          </div>
          <div class="row">
            <div class="col-6"><div class="panel-dicecount-item gray ui-item">3</div></div>
            <div class="col-6"><div class="panel-dicecount-item gray selected ui-item">4</div></div>
          </div>
          <div class="row">
            <div class="col-6"><div class="panel-dicecount-item gray ui-item">5</div></div>
            <div class="col-6"><div class="panel-dicecount-item gray ui-item">6</div></div>
          </div>
          <div class="row">
            <div class="col-6"><div class="panel-dicecount-item gray ui-item">7</div></div>
            <div class="col-6"><div class="panel-dicecount-item gray ui-item">8</div></div>
          </div>
          <div class="row">
            <div class="col-6"><div class="panel-dicecount-item gray ui-item">9</div></div>
            <div class="col-6"><div class="panel-dicecount-item gray ui-item">10</div></div>
          </div>
        </div>

        <div id="panel-contents" class="gray-lt absolute hidden container">
          <div class="row">
            <div class="col-6"><div class="test-000 content-item ui-item">1 1 of 2 <img src="img/spinner.svg"/> </div></div>
            <div class="col-6"><div class="test-001 content-item ui-item">2 2 of 2 </div></div>
            <div class="col-6"><div class="test-002 content-item ui-item">3 1 of 2 </div></div>
            <div class="col-6"><div class="test-003 content-item ui-item">4 2 of 2 </div></div>
            <div class="col-6"><div class="test-004 content-item ui-item">5 1 of 2 </div></div>
            <div class="col-6"><div class="test-005 content-item ui-item">6 2 of 2 </div></div>
            <div class="col-6"><div class="test-006 content-item ui-item">7 1 of 2 </div></div>
            <div class="col-6"><div class="test-007 content-item ui-item">8 2 of 2 </div></div>
            <div class="col-6"><div class="test-008 content-item ui-item">9 1 of 2 </div></div>
            <div class="col-6"><div class="test-009 content-item ui-item">10 2 of 2 </div></div>
          </div>
          <div class="row">
             <div class="col-6" onclick="panel_sum_click(this)"   ><div id="panel-contents-sum" class="gray ui-item">=</div></div>
             <div class="col-6" onclick="panel_close_click(this)" ><div class="gray ui-item">Close</div></div>
          </div>
        </div>

    </body>


        <script type="text/javascript">

function input_click(sender) {

    if(sender && sender.id === 'input-dice-count') {
        $('#panel-dicecount').removeClass('hidden');
        return;
    }

    if(sender && sender.id === 'input-dice-roll') {
        roll_all();
        return;
    }

    if(sender && sender.id === 'input-dice-type') {
        $('#panel-dicetype').removeClass('hidden');
        return;
    }
}

function is_rory() {
  let v = $('#panel-dicetype').find('.selected').html();
  return v === 'RR';
}

function is_fudge() {
  let v = $('#panel-dicetype').find('.selected').html();
  return v === 'FF';
}

function load_story(dom_item, data_icons, roll) {
  // let last_box = items[9];
  let count = data_icons.length - 1;
  let config = null;

  if(is_rory() ) {
    let _3d6 = dice_n(3, 6);

    config = {};

    $(dom_item).removeClass('hidden');
    dom_item.innerHTML = '-';
    if(18 < _3d6.total) {
      config.bg = 'red';
      config.fg = 'yellow';
    }
    else if(_3d6.total <= 4) {
      config.bg = 'red';
      config.fg = 'black';
    }
    config.direction = dice(4);
  }
  load_icon(dom_item,
      data_icons,
      roll || dice(count),
      config);
}

data_fudge_dice = [
  {id: 'fudge'},

	url_root + 'img/minus.svg',
	url_root + 'img/plus.svg',
	url_root + 'img/zero.svg',
];

function roll_all() {

    $('#panel-contents').removeClass('hidden');
    let count = $('#panel-dicecount').find('.selected').html();
    let type  = $('#panel-dicetype').find('.selected').html();
    let rr = false;
    let ff = is_fudge();
    let items = $('.content-item');
    let sum = 0;
    $('#panel-contents-sum').html('=');
    if(is_rory()) {
      type = 6;
      count = 9;
      rr = true;
      sum = '=';
    }
    
    if(ff) {
      type = 3;
      count = 4;
      sum = 0;
    }
    

    let pool = [];
    if(rr) {
      while(pool.length < count) {
        let v = dice(count);
        if(pool.indexOf(v) < 0) {
          pool.push(v);
        }
      }
    }

    let stories = [ '',
        data_story_group_1,
        data_story_group_2,
        data_story_group_3,
        data_story_group_4,
        data_story_group_5,
        data_story_group_6,
        data_story_group_7,
        data_story_group_8,
        data_story_group_9 ];


    for(let i = 0; i < items.length; ++i)
    {
        let $current = $(items[i]);
        $current.removeClass('no-pad');
        $current.removeClass('selected');
        $current.removeClass('hidden');
        $current.addClass('gray');
        $current.removeClass('red');
        let v = dice(type);

        // remove story images
        for(let r = 1; r <= 4; ++r) {
          $current.removeClass('rot' + r);
        }

        for(let ri = 1; ri <= 6; ++ri) {
          for(let rj = 1; rj <= 9; ++rj) {
            $current.removeClass('r' + rj + ri);
          }
        }
        // -- 
      
        if(i + 1 <= count)
        {
          if(rr) {
            load_story(items[i], stories[pool.pop()] );
            // items[i].innerHTML = '';
            // $current.removeClass('gray');
            // $current.addClass('r' + (pool.pop()) + v);
            // $current.addClass('rot' + dice(4) );
          }
          else if(ff) {
            let d = dice(6);
            switch(d) {
              case 1:
              case 2:
                items[i].innerHTML = '-';
                sum -= 1;
                load_story(items[i], data_fudge_dice, 1 );
                break;
              case 3:
              case 4:
                items[i].innerHTML = '+';
                sum += 1;
                load_story(items[i], data_fudge_dice, 2 );
                break;
              case 5:
              case 6:
                items[i].innerHTML = 'O';
                load_story(items[i], data_fudge_dice, 3 );
                break;
            }
          }
          else{
            $current.addClass('red');
            $current.removeClass('gray');
            items[i].innerHTML = v;
            sum += v;
          }
        }
        else
        {
            $current.addClass('hidden');
            items[i].innerHTML = '-';
        }
    }


    if(rr) {
      load_story(items[9], data_icons_actions );
      // let last_box = items[9];
      // // let d = data_story_group_1;
      // let d = data_story_group_3;
      // // let d = data_icons_actions;
      // let count = d.length - 1;
      // let config = {};
      // let _3d6 = dice_n(3, 6);

      // $(last_box).removeClass('hidden');
      // last_box.innerHTML = '-';

      // if(18 < _3d6.total) {
      //   config.bg = 'red';
      //   config.fg = 'yellow';
      // }
      // else if(_3d6.total <= 4) {
      //   config.bg = 'red';
      //   config.fg = 'black';
      // }
      // config.direction = dice(4);
      // load_icon(last_box,
      //     d,
      //     dice(count),
      //     config);
    }

    $('#panel-contents-sum').html(sum);
}

function panel_sum_click(sender) {
  roll_all();
  calculate_sum();
}

function panel_close_click(sender) {
    $(sender).parent().parent().addClass('hidden');
}

function on_load() 
{
    console.log("loading");

    consume_parameters();

    load_content();

    let items = $('.content-item');
    for(let i = 0; i < items.length; ++i)
    {
        items[i].addEventListener("click", (sender) => {
            content_item_click(sender);
        });
    }

    items = $('.panel-dicetype-item');
    for(let i = 0; i < items.length; ++i)
    {
        items[i].addEventListener("click", (sender) => {
            panel_dicetype_item_click(sender);
        });
    }

    items = $('.panel-dicecount-item');
    for(let i = 0; i < items.length; ++i)
    {
        items[i].addEventListener("click", (sender) => {
            panel_dicecount_item_click(sender);
        });
    }
}

let data_image_tooltips = [];

function load_icon(html_item, data_list, roll_result, params) {
  $(html_item).removeClass('no-pad');
  $(html_item).removeClass('rot1');
  $(html_item).removeClass('rot2');
  $(html_item).removeClass('rot3');
  $(html_item).removeClass('rot4');

  html_item.innerHTML = '<img src="img/spinner.svg" />';

  let cache = data.cache;
  let l = roll_result;

  let populate_dom = function(result, key) {
    
    // hack: removing from svg file isn't working. Cached maybe?
    let svg_image = result.replace('style="height: 512px; width: 512px;', '');

    let svg_tooltip = null;
    if(svg_tooltip) {

      let index = svg_image.indexOf('>') + 1; // the closing bracket of <svg ...  >
      svg_image = [ svg_image.slice(0, index),
                      '<title>',
                      svg_tooltip,
                      '</title>',
                      svg_image.slice(index) ].join('');

    }


    html_item.innerHTML = svg_image;
    $(html_item).addClass('no-pad');

    if(params) {
      if(params.direction) {
        $(html_item).addClass('rot' + params.direction);
      }

      if(params.bg) {
        $(html_item).find('path')[0].setAttribute('fill', params.bg);
      }

      if(params.fg) {
        $(html_item).find('path')[1].setAttribute('fill', params.fg);
      }

      if(params.is_crit) {
        $(html_item).find('path')[1].setAttribute('fill', 'yellow');
      }
      else if(params.is_fumble) {
        $(html_item).find('path')[1].setAttribute('fill', 'red');
      }
    }
  }

  let key = data_list[0].id + l;
  if(cache.get(key)) {

    let result = cache.get(key);

    populate_dom(result, key);

    return;
  }

  $.ajax(
    { url: data_list[l],
      dataType: 'text',
      success: function(result) {
        cache.add(key, result);

        populate_dom(result, key);
      }
    }
  );
}

function content_item_make_all_used() {

    let items = $('.content-item');
    for(let i = 0; i < items.length; ++i)
    {
        $(items[i]).removeClass('red');
        $(items[i]).addClass('gray');
    }
}

function calculate_sum() {

    if(is_fudge() ) {
      return;
    }

    let count = $('#panel-dicecount').find('.selected').html();
    let type  = $('#panel-dicetype').find('.selected').html();
    let items = $('.content-item');
    let sum = 0;
    $('#panel-contents-sum').html('=');
    if(is_rory()) {
      return;
    }
    for(let i = 0; i < items.length; ++i)
    {
        let v = Number(items[i].innerHTML);
        if(i + 1 <= count)
        {
          sum += v;
        }
    }

    $('#panel-contents-sum').html(sum);
}

function content_item_click(sender) {

    if(is_fudge() ) {
      return;
    }

    if(sender.target.innerHTML === '-') {
      return;
    }
  
    let count = $('#panel-dicecount').find('.selected').html();
    let type  = $('#panel-dicetype').find('.selected').html();
    let rr = false;
    let item = sender.target;
    let $item = $(item);
    
    let is_svg = sender.target.tagName === 'svg';
    let is_path = sender.target.tagName === 'path';

    if(is_rory() ) {
      
      // let div = sender.target;
      // while(div.nodeName.toUpperCase() !== 'DIV') {
      //   div = sender.parentElement;

      //   if(div.parentElement.toUpperCase() === 'BODY')
      //     break;
      // }

      // if(div.nodeName.toUpperCase('DIV') ) {
      //   let $div = $(div);
      //   $div.find('path').first().attr('fill', 'yellow');
      // }

      if($(sender.target).hasClass('selected')) {
        $item.removeClass('selected');
      }
      else {
        $item.addClass('selected');
      } 
      return;
    }
    
    content_item_make_all_used();


    if(is_path) {
      if(sender.target.parentNode.parentNode.tagName === 'DIV') {
        item = sender.target.parentNode.parentNode;
        item.innerHTML = '';
      }
    }
    else if(is_svg) {
      if(sender.target.parentNode.tagName === 'DIV') {
        item = sender.target.parentNode;
        item.innerHTML = '';
      }
    }



    item.innerHTML = dice(type);
    $item.removeClass('no-pad');
    $item.removeClass('gray');
    $item.addClass('red');

    calculate_sum();
}


function panel_dicetype_item_click(sender) {

  let id = '#panel-dicetype';
  let type = $(id).find('.selected');

  type.removeClass('selected');

  let selected = $(sender.target);
  selected.addClass('selected');

  $('#input-dice-type').find('.ui-item').html(selected.html());
  
  $(id).addClass('hidden');
}

function panel_dicecount_item_click(sender) {

  let id = '#panel-dicecount';
  let count = $(id).find('.selected');

  count.removeClass('selected');

  let selected = $(sender.target);
  selected.addClass('selected');

  $('#input-dice-count').find('.ui-item').html(selected.html());
  
  $(id).addClass('hidden');
}

function clear_content() {
    let content = document.getElementById('content');
    content.replaceChildren();
}

function load_content()
{
}

function consume_parameters()
{
    let url_string = window.location.href;
    let params = url_string.split('?')[1];
    let query_string = new URLSearchParams(params);
    
    console.log(query_string);
    for (let pair of query_string.entries()) {
    }
}

function button_onclick(sender)
{
    clear_content();
}

function textbox_onkeypress(event)
{
    if(event && event.keyCode && event.keyCode == 13 /*Enter*/)
    {
        clear_content();
        load_content(symbol_box().value);
    }
}

function div_new(id, text)
{
    let div = document.createElement('div');

    if(id)
        div.id = id;

    if(text)
        div.innerHTML = text;

    return div;
}

function link_new(url, text)
{
    let href = document.createElement('a');
    href.href = url;
    href.target = 'new';

    if(text)
        href.innerHTML = text;
    else
        href.innerHTML = url;

    return href;
}

function format(input, replace)
{
    let string = input;
    let tokens = [];
    for(let i = 0; i < 10; ++i)
    {
        tokens.push('\\{' + i + '\\}');
    }
    
    for (let i = 0; i < tokens.length; i++) {
        if(replace.length < i)
            break;

        string = string.replace(new RegExp(tokens[i], "g"), replace[i]);
    }

    return string;
}


on_load();

        </script>
</html>
